# yInsure Vulnerability Analysis: coverId/claimId Mismatch

**Finding ID**: FINDING-001
**Severity**: MEDIUM
**Contract**: 0x181aea6936b407514ebfc0754a37704eb8d98f91
**Chain**: Ethereum Mainnet
**Date**: 2026-02-02

## Executive Summary

A code bug exists in the yInsure contract where the `redeemClaim` function incorrectly passes `coverId` to `_payoutIsCompleted()` when it should pass `claimId`. This creates a potential timing attack vector where an attacker could drain funds under specific conditions.

## Contract Address
- **yInsure**: `0x181aea6936b407514ebfc0754a37704eb8d98f91`
- **Chain**: Ethereum Mainnet

## Vulnerability Details

### Code Analysis

In `redeemClaim()` function:
```solidity
function redeemClaim(uint256 tokenId) public onlyTokenApprovedOrOwner(tokenId) nonReentrant {
    require(tokens[tokenId].claimInProgress, "No claim is in progress");
    uint8 coverStatus;
    uint sumAssured;
    (, coverStatus, sumAssured, , ) = getCover(tokens[tokenId].coverId);

    require(coverStatus == uint8(CoverStatus.ClaimAccepted), "Claim is not accepted");
    require(_payoutIsCompleted(tokens[tokenId].coverId), "Claim accepted but payout not completed");  // BUG HERE

    _burn(tokenId);
    _sendAssuredSum(tokens[tokenId].coverCurrency, sumAssured);
    emit ClaimRedeemed(msg.sender, sumAssured, tokens[tokenId].coverCurrency);
}
```

The bug is on this line:
```solidity
require(_payoutIsCompleted(tokens[tokenId].coverId), ...);  // Should be claimId!
```

The `_payoutIsCompleted` function expects a `claimId`:
```solidity
function _payoutIsCompleted(uint claimId) internal view returns (bool) {
    uint256 status;
    Claims claims = Claims(nxMaster.getLatestAddress("CL"));
    (, status, , , ) = claims.getClaimbyIndex(claimId);
    return status == uint(ClaimStatus.FinalClaimAssessorVoteAccepted)
        || status == uint(ClaimStatus.ClaimAcceptedPayoutDone);
}
```

### Attack Vector

1. User buys cover through yInsure, receives tokenId with:
   - `coverId = X` (sequential ID in Nexus Mutual's cover system)
   - After submitting claim: `claimId = Y` (sequential ID in NXM claims system)

2. If `coverId (X)` happens to match a **different** completed claim's ID:
   - The `_payoutIsCompleted(X)` check returns `true`
   - Even if the user's actual claim (claimId=Y) is still pending

3. Attack conditions:
   - User's cover must have `coverStatus == ClaimAccepted` (claim was accepted by NXM)
   - Some other claim with `claimId == coverId` must be completed
   - yInsure contract must have sufficient balance to pay out

### Timing Attack Scenario

1. Attacker buys cover with `coverId = N`
2. Attacker submits claim, gets `claimId = M` (where M != N)
3. Nexus Mutual accepts the claim (`coverStatus = ClaimAccepted`)
4. NXM payout to yInsure is still pending (takes time for settlement)
5. If historical claim #N is already completed:
   - Attacker calls `redeemClaim(tokenId)`
   - `coverStatus == ClaimAccepted` check passes (using correct coverId)
   - `_payoutIsCompleted(N)` check passes (wrong check using coverId instead of claimId)
   - yInsure pays out `sumAssured` from its existing balance
6. yInsure loses funds before receiving NXM payout

## Economic Feasibility Analysis

### Current Contract State
- ETH Balance: ~0.134 ETH (134,202,124,637,845,822 wei)
- May hold other ERC20 tokens as well

### Attack Costs
- Gas for `redeemClaim`: ~100,000 gas (~$10-20 at current prices)
- Requires legitimate claim to be accepted by NXM (not trivial)

### Profitability Assessment
- **Gross Profit**: Up to contract balance (~0.134 ETH currently)
- **Net Profit**: Gross - gas costs
- **Minimum Attacker Tier**: TIER_1_DEFI_USER (needs NXM membership and valid cover)

### Constraints
1. Attacker must actually have a valid accepted claim (coverStatus = ClaimAccepted)
2. Their coverId must match an existing completed claim's claimId
3. Timing must be right (after claim acceptance, before NXM payout)

## Verification Steps

1. Check if coverIds and claimIds can overlap (both are sequential counters)
2. Check historical claim completion statuses
3. Check current yInsure token holdings and pending claims
4. Verify NXM payout settlement timing

## Severity Assessment

- **Technical Severity**: Medium-High (code bug confirmed)
- **Economic Severity**: Low (limited by contract balance and attack conditions)
- **Exploitability**: Medium (requires specific conditions to align)

## On-Chain Evidence

### yInsure Contract State

**Current ETH Balance**: 134,202,124,637,845,822 wei (~0.134 ETH)

### Sample Token Data (from mainnet query)

| Token ID | coverId | claimId | Observation |
|----------|---------|---------|-------------|
| 0 | 789 | 0 | No claim submitted |
| 1 | 790 | 27 | **Mismatch**: coverId != claimId |
| 2 | 799 | 28 | **Mismatch**: coverId != claimId |
| 3 | 800 | 0 | No claim submitted |
| 10 | 809 | 0 | No claim submitted |

### Vulnerability Evidence

Token 1 demonstrates the bug:
- **coverId**: 790
- **claimId**: 27
- When `redeemClaim(1)` is called, it checks `_payoutIsCompleted(790)` (claim 790)
- But should check `_payoutIsCompleted(27)` (claim 27)

If claim #790 is completed (belonging to a different user), and token 1's cover has status `ClaimAccepted`, the check passes incorrectly.

## Economic Feasibility Analysis

```json
{
  "finding_id": "FINDING-001",
  "severity": "MEDIUM",
  "title": "yInsure coverId/claimId Mismatch in redeemClaim",

  "economic_summary": {
    "max_gross_profit": "0.134 ETH",
    "costs": {
      "gas": "~0.005 ETH (150k gas at 30 gwei)",
      "nxm_cover_premium": "varies",
      "coordination": "timing-dependent"
    },
    "net_profit_estimate": "~0.129 ETH (if conditions align)",
    "minimum_attacker_tier": "TIER_1_DEFI_USER"
  },

  "feasibility_constraints": {
    "requires_nxm_membership": true,
    "requires_accepted_claim": true,
    "timing_dependent": true,
    "specific_id_collision": true
  }
}
```

### Attack Profitability Calculation

| Component | Value |
|-----------|-------|
| Max extractable (contract balance) | 0.134 ETH |
| Gas cost estimate | 0.005 ETH |
| Net profit (best case) | **0.129 ETH (~$310)** |

**Note**: Actual profitability depends on NXM claim acceptance and timing windows.

## Recommended Fix

Change line in `redeemClaim`:
```solidity
// Before (bug):
require(_payoutIsCompleted(tokens[tokenId].coverId), "Claim accepted but payout not completed");

// After (fix):
require(_payoutIsCompleted(tokens[tokenId].claimId), "Claim accepted but payout not completed");
```

## Severity Justification

- **Technical Bug**: Confirmed - code uses wrong variable
- **Economic Impact**: Limited by contract balance (~$320 at current prices)
- **Exploitability**: Medium - requires specific NXM claim conditions
- **Overall**: MEDIUM severity

## Disclosure Notes

This vulnerability was discovered during authorized security analysis. Recommend responsible disclosure to the yInsure/Yearn team.

---

**Session**: https://claude.ai/code/session_01QBHi4CMgXSXbynpnPqmuzb
