#!/usr/bin/env python3
"""
Scan contracts.txt for high-value targets not yet analyzed
Focus on less-audited contracts with significant TVL
"""

import json
import requests
from eth_abi import decode, encode
from eth_utils import keccak
import time

RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c"
ETHERSCAN_API = "https://api.etherscan.io/v2/api"
ETHERSCAN_KEY = "5UWN6DNT7UZCEJYNE3J6FCVAWH4QJW255K"

def get_eth_balance(address):
    payload = {
        "jsonrpc": "2.0",
        "method": "eth_getBalance",
        "params": [address, "latest"],
        "id": 1
    }
    try:
        resp = requests.post(RPC_URL, json=payload, timeout=10)
        return int(resp.json().get("result", "0x0"), 16)
    except:
        return 0

def get_contract_name(address):
    url = f"{ETHERSCAN_API}?chainid=1&module=contract&action=getsourcecode&address={address}&apikey={ETHERSCAN_KEY}"
    try:
        resp = requests.get(url, timeout=10)
        data = resp.json()
        if data.get('status') == '1' and data.get('result'):
            return data['result'][0].get('ContractName', 'Unknown')
    except:
        pass
    return "Unknown"

def format_ether(wei):
    return f"{wei / 1e18:.4f}"

def main():
    print("=" * 60)
    print("HIGH-VALUE CONTRACT SCANNER")
    print("=" * 60)

    # Read contracts.txt
    with open('/home/user/contracs/contracts.txt', 'r') as f:
        lines = f.readlines()

    addresses = []
    for line in lines:
        addr = line.strip()
        if addr.startswith('0x') and len(addr) == 42:
            addresses.append(addr)

    print(f"\nLoaded {len(addresses)} addresses")
    print("\nScanning for high ETH balances (> 100 ETH)...")

    high_value = []
    batch_size = 50
    eth_price = 2279  # Current ETH price

    # Skip first 200 addresses (likely already analyzed)
    start_idx = 200

    for i in range(start_idx, min(start_idx + 300, len(addresses))):
        addr = addresses[i]
        balance = get_eth_balance(addr)

        if balance > 100 * 1e18:  # > 100 ETH
            usd_value = (balance / 1e18) * eth_price
            high_value.append({
                'index': i + 1,
                'address': addr,
                'balance': balance,
                'usd_value': usd_value
            })
            print(f"Found: #{i+1} {addr} - {format_ether(balance)} ETH (${usd_value:,.0f})")

        # Rate limiting
        if (i - start_idx + 1) % 20 == 0:
            print(f"Scanned {i - start_idx + 1} addresses...")
            time.sleep(0.5)

    print(f"\n\n{'=' * 60}")
    print(f"HIGH-VALUE CONTRACTS FOUND: {len(high_value)}")
    print('=' * 60)

    # Sort by balance
    high_value.sort(key=lambda x: x['balance'], reverse=True)

    # Get contract names for top candidates
    print("\nFetching contract names for top targets...")
    for item in high_value[:20]:
        name = get_contract_name(item['address'])
        item['name'] = name
        print(f"\n#{item['index']}: {item['address']}")
        print(f"  Name: {name}")
        print(f"  Balance: {format_ether(item['balance'])} ETH (${item['usd_value']:,.0f})")

        # Flag interesting patterns
        interesting = False
        if 'vault' in name.lower():
            print("  INTERESTING: Vault contract")
            interesting = True
        if 'reward' in name.lower():
            print("  INTERESTING: Reward contract")
            interesting = True
        if 'staking' in name.lower():
            print("  INTERESTING: Staking contract")
            interesting = True
        if 'bridge' in name.lower():
            print("  INTERESTING: Bridge contract")
            interesting = True
        if name == 'Unknown' or name == '':
            print("  INTERESTING: Unverified contract")
            interesting = True

        time.sleep(0.3)

    print("\n" + "=" * 60)
    print("SCAN COMPLETE")
    print("=" * 60)

if __name__ == "__main__":
    main()
