// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Script.sol";

interface IAggregator {
    function getMainManager(address strategy) external view returns (address);
    function getSecondaryManagers(address strategy) external view returns (address[] memory);
    function getGlobalHooksRoot() external view returns (bytes32);
    function getStrategyHooksRoot(address strategy) external view returns (bytes32);
    function getPPS(address strategy) external view returns (uint256);
    function getMaxStaleness(address strategy) external view returns (uint256);
    function getMinUpdateInterval(address strategy) external view returns (uint256);
    function getLastUpdateTimestamp(address strategy) external view returns (uint256);
    function isPPSStale(address strategy) external view returns (bool);
    function isStrategyPaused(address strategy) external view returns (bool);
}

interface IStrategy {
    function getYieldSourcesList() external view returns (address[] memory);
    function getYieldSourcesCount() external view returns (uint256);
    function getStoredPPS() external view returns (uint256);
    function vaultHwmPps() external view returns (uint256);
    function vaultUnrealizedProfit() external view returns (uint256);
    function getSuperVaultState() external view returns (
        uint256 totalAssets,
        uint256 totalShares,
        uint256 currentPPS,
        uint256 hwmPPS
    );
}

interface ISuperVault {
    function totalAssets() external view returns (uint256);
    function totalSupply() external view returns (uint256);
    function convertToAssets(uint256 shares) external view returns (uint256);
}

interface IPendleSY {
    function exchangeRate() external view returns (uint256);
    function yieldToken() external view returns (address);
    function getTokensIn() external view returns (address[] memory);
    function getTokensOut() external view returns (address[] memory);
    function totalSupply() external view returns (uint256);
}

interface IPendleMarket {
    function readTokens() external view returns (address sy, address pt, address yt);
    function getReserves() external view returns (uint128 syReserves, uint128 ptReserves);
    function expiry() external view returns (uint256);
}

contract QueryState is Script {
    address constant AGGREGATOR = 0x10AC0b33e1C4501CF3ec1cB1AE51ebfdbd2d4698;
    address constant STRATEGY = 0x41A9Eb398518D2487301c61D2b33E4e966A9F1DD;
    address constant SUPERVAULT = 0xf6EbeA08a0Dfd44825f67Fa9963911c81BE2a947;
    address constant PENDLE_SY = 0x4D654F255D54637112844bd8802b716170904FeE;
    address constant PENDLE_MARKET = 0x3D83a85e0B0fe9cC116A4EFc61bb29Cb29C3cb9a;

    function run() public view {
        console.log("=== CRITICAL UNKNOWNS QUERY ===");
        console.log("");

        // 1. MANAGER IDENTITY
        console.log("1. MANAGER IDENTITY");
        console.log("-------------------");
        try IAggregator(AGGREGATOR).getMainManager(STRATEGY) returns (address mainManager) {
            console.log("   Main Manager:", mainManager);
        } catch {
            console.log("   Main Manager: FAILED TO QUERY");
        }

        try IAggregator(AGGREGATOR).getSecondaryManagers(STRATEGY) returns (address[] memory secondary) {
            console.log("   Secondary Managers Count:", secondary.length);
            for (uint i = 0; i < secondary.length && i < 5; i++) {
                console.log("     -", secondary[i]);
            }
        } catch {
            console.log("   Secondary Managers: FAILED TO QUERY");
        }
        console.log("");

        // 2. YIELD SOURCES
        console.log("2. YIELD SOURCES");
        console.log("----------------");
        try IStrategy(STRATEGY).getYieldSourcesList() returns (address[] memory sources) {
            console.log("   Yield Sources Count:", sources.length);
            for (uint i = 0; i < sources.length && i < 30; i++) {
                console.log("     Source", i, ":", sources[i]);
            }
        } catch {
            console.log("   Yield Sources: FAILED TO QUERY");
        }
        console.log("");

        // 3. HOOKS ROOTS
        console.log("3. HOOKS CONFIGURATION");
        console.log("----------------------");
        try IAggregator(AGGREGATOR).getGlobalHooksRoot() returns (bytes32 globalRoot) {
            console.log("   Global Hooks Root:");
            console.logBytes32(globalRoot);
        } catch {
            console.log("   Global Hooks Root: FAILED TO QUERY");
        }

        try IAggregator(AGGREGATOR).getStrategyHooksRoot(STRATEGY) returns (bytes32 strategyRoot) {
            console.log("   Strategy Hooks Root:");
            console.logBytes32(strategyRoot);
        } catch {
            console.log("   Strategy Hooks Root: FAILED TO QUERY");
        }
        console.log("");

        // 4. PPS / ORACLE STATE
        console.log("4. PPS / ORACLE STATE");
        console.log("---------------------");
        try IAggregator(AGGREGATOR).getPPS(STRATEGY) returns (uint256 pps) {
            console.log("   Current PPS:", pps);
        } catch {
            console.log("   Current PPS: FAILED TO QUERY");
        }

        try IAggregator(AGGREGATOR).getLastUpdateTimestamp(STRATEGY) returns (uint256 ts) {
            console.log("   Last Update Timestamp:", ts);
            console.log("   Age (seconds):", block.timestamp - ts);
        } catch {
            console.log("   Last Update Timestamp: FAILED TO QUERY");
        }

        try IAggregator(AGGREGATOR).getMaxStaleness(STRATEGY) returns (uint256 maxStale) {
            console.log("   Max Staleness:", maxStale);
        } catch {
            console.log("   Max Staleness: FAILED TO QUERY");
        }

        try IAggregator(AGGREGATOR).isPPSStale(STRATEGY) returns (bool isStale) {
            console.log("   Is PPS Stale:", isStale);
        } catch {
            console.log("   Is PPS Stale: FAILED TO QUERY");
        }
        console.log("");

        // 5. SUPERVAULT STATE
        console.log("5. SUPERVAULT STATE");
        console.log("-------------------");
        try ISuperVault(SUPERVAULT).totalAssets() returns (uint256 assets) {
            console.log("   Total Assets (USDC):", assets);
        } catch {
            console.log("   Total Assets: FAILED TO QUERY");
        }

        try ISuperVault(SUPERVAULT).totalSupply() returns (uint256 supply) {
            console.log("   Total Supply (shares):", supply);
        } catch {
            console.log("   Total Supply: FAILED TO QUERY");
        }

        try IStrategy(STRATEGY).vaultHwmPps() returns (uint256 hwm) {
            console.log("   High Water Mark PPS:", hwm);
        } catch {
            console.log("   High Water Mark: FAILED TO QUERY");
        }

        try IStrategy(STRATEGY).vaultUnrealizedProfit() returns (uint256 profit) {
            console.log("   Unrealized Profit:", profit);
        } catch {
            console.log("   Unrealized Profit: FAILED TO QUERY");
        }
        console.log("");

        // 6. PENDLE STATE
        console.log("6. PENDLE STATE");
        console.log("---------------");
        try IPendleSY(PENDLE_SY).exchangeRate() returns (uint256 rate) {
            console.log("   SY Exchange Rate:", rate);
        } catch {
            console.log("   SY Exchange Rate: FAILED TO QUERY");
        }

        try IPendleSY(PENDLE_SY).totalSupply() returns (uint256 supply) {
            console.log("   SY Total Supply:", supply);
        } catch {
            console.log("   SY Total Supply: FAILED TO QUERY");
        }

        try IPendleMarket(PENDLE_MARKET).expiry() returns (uint256 exp) {
            console.log("   Market Expiry:", exp);
        } catch {
            console.log("   Market Expiry: FAILED TO QUERY");
        }

        try IPendleMarket(PENDLE_MARKET).getReserves() returns (uint128 syRes, uint128 ptRes) {
            console.log("   SY Reserves:", syRes);
            console.log("   PT Reserves:", ptRes);
        } catch {
            console.log("   Market Reserves: FAILED TO QUERY");
        }

        console.log("");
        console.log("=== QUERY COMPLETE ===");
    }
}
