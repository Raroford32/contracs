#!/usr/bin/env python3
"""
Identify all protocols in contracts.txt and categorize them.
Focus on finding newer or less audited protocols.
"""

import requests
import time

ETHERSCAN_API = "https://api.etherscan.io/v2/api"
ETHERSCAN_KEY = "5UWN6DNT7UZCEJYNE3J6FCVAWH4QJW255K"
RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c"

def get_eth_balance(address):
    payload = {
        "jsonrpc": "2.0",
        "method": "eth_getBalance",
        "params": [address, "latest"],
        "id": 1
    }
    try:
        resp = requests.post(RPC_URL, json=payload, timeout=10)
        return int(resp.json().get("result", "0x0"), 16)
    except:
        return 0

def get_contract_info(address):
    url = f"{ETHERSCAN_API}?chainid=1&module=contract&action=getsourcecode&address={address}&apikey={ETHERSCAN_KEY}"
    try:
        resp = requests.get(url, timeout=30)
        data = resp.json()
        if data.get('status') == '1' and data.get('result'):
            result = data['result'][0]
            return {
                'name': result.get('ContractName', 'Unknown'),
                'compiler': result.get('CompilerVersion', ''),
                'has_source': bool(result.get('SourceCode')),
                'proxy': result.get('Proxy', '0') == '1',
                'implementation': result.get('Implementation', '')
            }
    except:
        pass
    return None

def categorize_contract(name, source_code=''):
    """Categorize contract by name/source"""
    name_lower = name.lower()

    categories = {
        'DEX/AMM': ['swap', 'router', 'pair', 'pool', 'exchange', 'dex', 'amm', 'uniswap', 'sushi', 'curve', 'balancer'],
        'Lending': ['lending', 'borrow', 'compound', 'aave', 'vault', 'ctoken', 'cerc', 'cauldron'],
        'Staking': ['staking', 'stake', 'farm', 'reward', 'mining', 'masterchef'],
        'Bridge': ['bridge', 'messenger', 'relay', 'crosschain', 'l1', 'l2'],
        'Token': ['token', 'erc20', 'erc721', 'erc1155', 'nft'],
        'Governance': ['governance', 'timelock', 'voting', 'dao', 'treasury'],
        'Proxy': ['proxy', 'upgradeable', 'implementation'],
        'Oracle': ['oracle', 'price', 'chainlink', 'tellor'],
        'Derivatives': ['perp', 'future', 'option', 'synthetic', 'synth'],
        'Yield': ['yield', 'yearn', 'strategy', 'harvester', 'convex'],
    }

    for category, keywords in categories.items():
        for kw in keywords:
            if kw in name_lower:
                return category

    return 'Unknown'

def main():
    print("=" * 70)
    print("PROTOCOL IDENTIFICATION")
    print("=" * 70)

    with open('/home/user/contracs/contracts.txt', 'r') as f:
        addresses = [line.strip() for line in f if line.strip().startswith('0x') and len(line.strip()) == 42]

    print(f"Total contracts: {len(addresses)}")

    # Analyze first 200 contracts (higher TVL)
    results = []
    categories_count = {}

    for i, addr in enumerate(addresses[:200]):
        if i % 20 == 0:
            print(f"Progress: {i}/200")
            time.sleep(1)  # Rate limit

        info = get_contract_info(addr)
        eth_bal = get_eth_balance(addr)

        if info:
            category = categorize_contract(info['name'])
            categories_count[category] = categories_count.get(category, 0) + 1

            results.append({
                'address': addr,
                'name': info['name'],
                'category': category,
                'eth_balance': eth_bal / 1e18,
                'has_source': info['has_source'],
                'proxy': info['proxy'],
                'compiler': info['compiler']
            })

        time.sleep(0.2)

    # Print summary
    print("\n" + "=" * 70)
    print("CATEGORY BREAKDOWN")
    print("=" * 70)
    for cat, count in sorted(categories_count.items(), key=lambda x: -x[1]):
        print(f"  {cat}: {count}")

    # Print interesting contracts
    print("\n" + "=" * 70)
    print("HIGH-VALUE CONTRACTS BY CATEGORY")
    print("=" * 70)

    # Sort by ETH balance
    results.sort(key=lambda x: -x['eth_balance'])

    for category in ['Lending', 'Staking', 'Yield', 'DEX/AMM', 'Unknown']:
        print(f"\n--- {category} ---")
        cat_results = [r for r in results if r['category'] == category and r['eth_balance'] > 10]
        for r in cat_results[:10]:
            compiler_year = '2020+' if 'v0.8' in r['compiler'] or 'v0.7' in r['compiler'] else 'older'
            print(f"  {r['name'][:30]:30} {r['eth_balance']:>10.2f} ETH  {compiler_year}")
            print(f"    Address: {r['address']}")

    # Find contracts that might be interesting targets
    print("\n" + "=" * 70)
    print("POTENTIAL TARGETS (newer compiler, high value, unique names)")
    print("=" * 70)

    interesting = []
    for r in results:
        # Look for:
        # 1. Newer compiler (0.8+)
        # 2. High value (>100 ETH)
        # 3. Unknown category (might be unique mechanics)
        # 4. Lending/Yield (complex interactions)

        is_newer = 'v0.8' in r['compiler'] or 'v0.7' in r['compiler']
        is_high_value = r['eth_balance'] > 100
        is_interesting_category = r['category'] in ['Unknown', 'Lending', 'Yield', 'Staking']

        if is_high_value and (is_newer or is_interesting_category):
            interesting.append(r)

    for r in interesting[:20]:
        print(f"\n{r['name']} ({r['address']})")
        print(f"  Category: {r['category']}")
        print(f"  ETH: {r['eth_balance']:.2f}")
        print(f"  Compiler: {r['compiler']}")
        print(f"  Proxy: {r['proxy']}")

    # Save for further analysis
    import json
    with open('protocol_identification.json', 'w') as f:
        json.dump(results, f, indent=2)

    print("\nResults saved to protocol_identification.json")

if __name__ == "__main__":
    main()
