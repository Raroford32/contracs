#!/usr/bin/env python3
"""
Check if the Parity wallet proxies have initialized storage.
If m_required and m_numOwners are 0, the wallet is uninitialized.
"""

import requests
from eth_abi import encode
from eth_utils import keccak

RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c"

PROXIES = [
    ("0x10abe2494e4525f8cd2bac772671f0e1a44c6975", 10060),
    ("0x88aa042c4aae423e0f1bb48542b473d1dd20a807", 9383),
]

# Storage slots from Wallet contract:
# uint public m_required;      // slot 0
# uint public m_numOwners;     // slot 1
# uint[256] m_owners;          // slot 2-257
# c_maxOwners = 250 (constant, not in storage)
# mapping(uint => uint) m_ownerIndex; // slot 258 (but mappings are hashed)
# mapping(bytes32 => PendingState) m_pending; // slot 259
# bytes32[] m_pendingIndex;    // slot 260
# uint public m_dailyLimit;    // slot 261
# uint public m_spentToday;    // slot 262
# uint public m_lastDay;       // slot 263
# uint public version = 2;     // slot 264 (from Wallet)
# mapping (bytes32 => Transaction) m_txs; // slot 265

def get_storage_at(address, slot):
    payload = {
        "jsonrpc": "2.0",
        "method": "eth_getStorageAt",
        "params": [address, hex(slot), "latest"],
        "id": 1
    }
    try:
        resp = requests.post(RPC_URL, json=payload, timeout=10)
        return resp.json().get("result", "0x")
    except:
        return "0x"

def get_eth_balance(address):
    payload = {
        "jsonrpc": "2.0",
        "method": "eth_getBalance",
        "params": [address, "latest"],
        "id": 1
    }
    try:
        resp = requests.post(RPC_URL, json=payload, timeout=10)
        return int(resp.json().get("result", "0x0"), 16)
    except:
        return 0

def main():
    print("=" * 70)
    print("PARITY WALLET PROXY STORAGE CHECK")
    print("=" * 70)

    for proxy, expected_eth in PROXIES:
        print(f"\n--- Proxy: {proxy} ---")

        balance = get_eth_balance(proxy)
        print(f"ETH Balance: {balance / 1e18:.2f} ETH (${balance / 1e18 * 2279:,.0f})")

        # Check storage slots
        storage_checks = [
            (0, "m_required"),
            (1, "m_numOwners"),
            (2, "m_owners[0]"),
            (3, "m_owners[1]"),
            (4, "m_owners[2]"),
            (261, "m_dailyLimit"),
            (262, "m_spentToday"),
            (263, "m_lastDay"),
            (264, "version"),
        ]

        for slot, name in storage_checks:
            value = get_storage_at(proxy, slot)
            int_value = int(value, 16) if value != "0x" else 0
            if int_value > 0:
                if 'owner' in name.lower():
                    addr = "0x" + value[-40:]
                    print(f"  Slot {slot:3} ({name:15}): {addr}")
                else:
                    print(f"  Slot {slot:3} ({name:15}): {int_value}")
            else:
                print(f"  Slot {slot:3} ({name:15}): 0 (unset)")

        # If m_required == 0, the wallet is UNINITIALIZED
        m_required = int(get_storage_at(proxy, 0), 16)
        m_numOwners = int(get_storage_at(proxy, 1), 16)

        if m_required == 0 and m_numOwners == 0:
            print("\n  !!! WALLET IS UNINITIALIZED !!!")
            print("  This means NO owners are set and functions requiring owners will fail")
            print("  BUT it also means the wallet can potentially be initialized by anyone!")

        # Check if we can initialize
        print("\n  Checking if initialization is possible...")

        # The Wallet constructor requires:
        # function Wallet(address[] _owners, uint _required, uint _daylimit)
        # But constructors can't be called after deployment

        # The library's multiowned constructor is:
        # function multiowned(address[] _owners, uint _required)
        # This also can't be called directly

        print("  Constructors cannot be called after deployment")
        print("  These contracts are stuck - no way to initialize or withdraw")

    print("\n" + "=" * 70)
    print("ANALYSIS")
    print("=" * 70)
    print("""
The Parity wallet proxies use CALLCODE with only 9050 gas to delegate to
the library at 0x273930d21e01ee25e4c219b63259d214872220a2.

Key findings:
1. The proxies appear to have 0 storage (uninitialized)
2. With 0 owners, no function with onlyowner or onlymanyowners will execute
3. 9050 gas is not enough for most operations anyway
4. The constructor cannot be called after deployment

This is the same pattern as the Parity wallet freeze incident from November 2017
where ~500k ETH was frozen due to the library being self-destructed.

The ETH in these contracts is PERMANENTLY FROZEN and cannot be extracted
without changes to Ethereum itself (which won't happen for these contracts).

CONCLUSION: Not exploitable - funds are permanently locked.
""")

if __name__ == "__main__":
    main()
