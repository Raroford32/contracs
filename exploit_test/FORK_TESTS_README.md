# Mainnet Fork Testing Guide

This directory contains proof-of-concept tests for **reproducible vulnerabilities** that can be validated on a mainnet fork.

## Prerequisites

```bash
# Install Foundry
curl -L https://foundry.paradigm.xyz | bash
foundryup
```

## High-TVL Attack Vectors (Fork Reproducible)

### 1. Curve Read-Only Reentrancy (`CurveReadOnlyReentrancyPOC.t.sol`)

**Target TVL:** ~$400M+ (Curve stETH/ETH pool)
**Capital Required:** Flash loan (0 net capital) + gas
**Real Exploits:** dForce $3.65M, Sentiment $1M, Sturdy $800K

```bash
# Run the POC
forge test --match-path test/CurveReadOnlyReentrancyPOC.t.sol -vvv --fork-url https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY

# Test specific functions
forge test --match-test test_01_normalVirtualPrice -vvv --fork-url $RPC_URL
forge test --match-test test_02_virtualPriceDuringCallback -vvv --fork-url $RPC_URL
```

**What it demonstrates:**
- `virtual_price` is manipulated during `remove_liquidity` callbacks
- Any protocol reading `virtual_price` during callback sees deflated value
- Enables unfair liquidations and borrowing against fake collateral values

### 2. First Depositor Inflation Attack (`FirstDepositorInflationPOC.t.sol`)

**Capital Required:** ~$100-1000 + gas
**Profit:** Up to 50% of victim deposits
**Real Exploits:** ResupplyFi $9.56M (June 2025), Venus $717K (Feb 2025)

```bash
# Run mock demonstration (no fork needed)
forge test --match-path test/FirstDepositorInflationPOC.t.sol --match-test test_firstDepositorAttack -vvv

# Scan for empty vaults on mainnet
forge test --match-test test_scanForEmptyVaults -vvv --fork-url $RPC_URL

# Test virtual shares mitigation
forge test --match-test test_virtualSharesMitigation -vvv
```

**What it demonstrates:**
- Attack math: deposit 1 wei → donate → victim gets 0 shares
- Scans contracts.txt for potentially empty vaults
- Shows OpenZeppelin virtual shares mitigation

## Running All Tests

```bash
# Full suite on mainnet fork
export RPC_URL="https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY"
forge test --fork-url $RPC_URL -vvv

# Quick local tests (no fork)
forge test --match-test test_firstDepositorAttack -vvv
forge test --match-test test_shareCalculationMath -vvv
```

## Expected Output

### Curve Reentrancy Test
```
=== RESULTS ===
VP Before: 1023456789012345678
VP During Callback: 1013456789012345678  (LOWER!)
VP After: 1023456789012345678

!!! VULNERABILITY CONFIRMED !!!
Virtual price DROPPED during callback
Deviation: 98 basis points
```

### First Depositor Test
```
=== STEP 3: Victim deposits ===
Victim wants to deposit: 99999 tokens
Victim shares received: 0

!!! VULNERABILITY CONFIRMED !!!
Victim received 0 shares for 99999 tokens!

=== RESULTS ===
Attacker P&L: 49999 tokens
Victim LOST: 99999 tokens
```

## Contracts from contracts.txt Tested

| Address | Protocol | Test Coverage |
|---------|----------|---------------|
| `0x93054188d876f558f4a66b2ef1d97d16edf0895b` | Curve renBTC | Read-only reentrancy |
| `0xc5cfada84e902ad92dd40194f0883ad49639b023` | Curve GUSD Gauge | Scanned |
| `0x16de59092dae5ccf4a1e6439d611fd0653f0bd01` | Yearn yDAI V1 | Empty vault scan |
| `0x4f6a43ad7cba042606decaca730d4ce0a57ac62e` | Saddle BTC | First depositor |

## Responsible Disclosure

These tests are for **authorized security research only**. If you discover exploitable conditions:

1. **DO NOT** exploit on mainnet
2. Report via Immunefi bug bounty (most protocols listed)
3. Contact protocol security teams directly
4. Wait for patch before public disclosure

## Bug Bounty Programs

| Protocol | Platform | Max Payout |
|----------|----------|------------|
| Curve | Immunefi | $250K |
| Lido | Immunefi | $2M |
| Uniswap | Immunefi | $2.25M |
| Yearn | Immunefi | $200K |
