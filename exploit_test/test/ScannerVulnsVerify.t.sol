// SPDX-License-Identifier: MIT
pragma solidity ^0.8.26;

import "forge-std/Test.sol";

/**
 * @title Scanner Vulnerabilities - On-Chain Verification
 * @notice Verify EVERY unique vector from scanner output against LIVE mainnet
 */

interface IV3Vault {
    function asset() external view returns (address);
    function transformerAllowList(address) external view returns (bool);
    function vaultInfo() external view returns (uint256,uint256,uint256,uint256,uint256,uint256);
}

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
}

contract ScannerVulnsVerify is Test {
    IV3Vault constant vault = IV3Vault(0xa2754543f69dC036764bBfad16d2A74F5cD15667);
    address constant USDC = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
    address constant FLASHLOAN_LIQ = 0xa44080F20464de260e25F35A69d6BDa50f2cc79D;
    
    // All known Revert transformers
    address constant LEVERAGE = 0x227AcFb22A7b6E0c91021e861f50926d3c553A96;
    address constant AUTO_COMPOUND = 0x5411894842e610C4D0F6Ed4C232DA689400f94A1;
    address constant AUTO_RANGE = 0x7be3ec3eDB9f3E09B1E7F1d08B14F41e7bE0a510;
    address constant AUTO_EXIT = 0xEc22D7D8c1A384b66Ac4f8a8c3eE73AF27BdbB98;
    address constant V3_UTILS = 0x8d83B5cf7B09E9D3708E16312aa16d4A6Fe8dC54;

    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
    }

    function test_ALL_VECTORS_VERIFICATION() public view {
        console.log("=================================================");
        console.log("  SCANNER VULNERABILITIES - MAINNET VERIFICATION  ");
        console.log("=================================================");
        console.log("");

        // 1. ASSET CHECK (blocks FOT, reentrancy, callbacks)
        address asset = vault.asset();
        bool isUSDC = asset == USDC;
        console.log("ASSET:", asset);
        console.log("Is USDC:", isUSDC);
        console.log("");

        // 2. TRANSFORMER WHITELIST (blocks stale owner, approval leak)
        bool lev = vault.transformerAllowList(LEVERAGE);
        bool ac = vault.transformerAllowList(AUTO_COMPOUND);
        bool ar = vault.transformerAllowList(AUTO_RANGE);
        bool ae = vault.transformerAllowList(AUTO_EXIT);
        bool v3u = vault.transformerAllowList(V3_UTILS);
        
        console.log("TRANSFORMER WHITELIST:");
        console.log("  LeverageTransformer:", lev);
        console.log("  AutoCompound:", ac);
        console.log("  AutoRange:", ar);
        console.log("  AutoExit:", ae);
        console.log("  V3Utils:", v3u);
        bool anyTransformer = lev || ac || ar || ae || v3u;
        console.log("  ANY WHITELISTED:", anyTransformer);
        console.log("");

        // 3. FLASHLOAN LIQUIDATOR BALANCE
        uint256 flBal = IERC20(USDC).balanceOf(FLASHLOAN_LIQ);
        console.log("FlashloanLiquidator USDC:", flBal);
        console.log("");

        // 4. EXCHANGE RATE
        (,,,, uint256 debtRate, uint256 lendRate) = vault.vaultInfo();
        uint256 Q96 = 2**96;
        console.log("Exchange Rates:");
        console.log("  Lend rate:", lendRate);
        console.log("  Q96 baseline:", Q96);
        console.log("  Rate healthy:", lendRate > 0);
        console.log("");

        console.log("=================================================");
        console.log("        VERDICT: BLOCKED VECTORS SUMMARY         ");
        console.log("=================================================");
        console.log("");
        
        console.log("| Scanner ID | Vector | BLOCKED BY |");
        console.log("|------------|--------|------------|");
        
        if (isUSDC) {
            console.log("| Fi:F12,F35,F15,F6,F24 | Fee-on-transfer | USDC standard |");
            console.log("| Fi:F1,F18 | Repay reentrancy | USDC no callbacks |");
            console.log("| Fi:F30,F25 | Liquidation reentry | USDC no hooks |");
        }
        
        if (!anyTransformer) {
            console.log("| Fi:F6,F7,F2,F9,F15 | Stale tokenOwner | No transformers |");
            console.log("| Fi:F6 | Transform approval | No transformers |");
        }
        
        if (flBal == 0) {
            console.log("| Fi:F3,F4,F29 | FlashloanLiq callback | Zero balance |");
        }
        
        if (lendRate > 0) {
            console.log("| Fi:F1,F33 | Exchange rate zero | Rate healthy |");
        }
        
        console.log("");
        console.log("REMAINING (not immediate drains):");
        console.log("| Fi:F3,F1 | Interest manipulation | Economic only |");
        console.log("| Fi:F6,F23 | Liquidation DoS | Bad debt risk |");
        console.log("| Fi:F4,F9,etc | AutoCompound MEV | Position MEV |");
        console.log("| Fi:F13 | V3Utils bypass | Needs NFT in contract |");
        console.log("| Fi:F5 | Div by zero | Edge case |");
        console.log("| Fi:F9,F17 | validateSwap math | Needs executor |");
        console.log("");
        
        console.log("=================================================");
        if (isUSDC && !anyTransformer && flBal == 0 && lendRate > 0) {
            console.log("  CONCLUSION: ZERO IMMEDIATE DRAINS POSSIBLE    ");
            console.log("  All Category-A vectors blocked on mainnet     ");
        } else {
            console.log("  WARNING: SOME BLOCKERS NOT PRESENT            ");
        }
        console.log("=================================================");
    }
}
