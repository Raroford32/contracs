// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

interface IFraxEtherRedemptionQueue {
    function redemptionQueueState() external view returns (uint64, uint64, uint64, uint64);
    function redemptionQueueAccounting() external view returns (uint128 etherLiabilities, uint128 unclaimedFees);
    function nftInformation(uint256 nftId) external view returns (bool hasBeenRedeemed, uint64 maturity, uint120 amount, uint64 earlyExitFee);
    function ownerOf(uint256 tokenId) external view returns (address);
}

contract FraxQueueMatureNFTsTest is Test {
    address constant FRAX_QUEUE = 0x82bA8da44Cd5261762e629dd5c605b17715727bd;
    
    IFraxEtherRedemptionQueue queue;
    
    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
        queue = IFraxEtherRedemptionQueue(FRAX_QUEUE);
    }
    
    function testFindMatureNFTs() public view {
        console.log("=== SEARCHING FOR MATURE NFTs ===");
        console.log("Current timestamp:", block.timestamp);
        
        (uint64 nextNftId,,,) = queue.redemptionQueueState();
        console.log("Total NFTs minted:", nextNftId);
        
        uint256 totalMatureAmount = 0;
        uint256 matureCount = 0;
        
        // Check all NFTs
        for (uint256 i = 0; i < nextNftId; i++) {
            (bool hasBeenRedeemed, uint64 maturity, uint120 amount,) = queue.nftInformation(i);
            
            // Skip redeemed or zero-amount NFTs
            if (hasBeenRedeemed || amount == 0) continue;
            
            // Check if mature
            if (block.timestamp >= maturity) {
                matureCount++;
                totalMatureAmount += amount;
                
                // Get owner
                try queue.ownerOf(i) returns (address owner) {
                    if (matureCount <= 20) { // Only log first 20
                        console.log("\n[MATURE NFT]");
                        console.log("  ID:", i);
                        console.log("  Amount:", amount / 1e18, "ETH");
                        console.log("  Owner:", owner);
                    }
                } catch {
                    // NFT was burned or doesn't exist
                }
            }
        }
        
        console.log("\n=== SUMMARY ===");
        console.log("Total Mature NFTs:", matureCount);
        console.log("Total Mature Amount:", totalMatureAmount / 1e18, "ETH");
        
        uint256 ethBalance = FRAX_QUEUE.balance;
        console.log("\nContract ETH Balance:", ethBalance / 1e18, "ETH");
        
        if (totalMatureAmount > ethBalance) {
            console.log("\n!!! CRITICAL: Mature NFTs exceed ETH balance !!!");
            console.log("Shortfall for mature NFTs:", (totalMatureAmount - ethBalance) / 1e18, "ETH");
        }
    }
    
    function testCheckSpecificNFTs() public view {
        console.log("=== CHECKING SPECIFIC NFT RANGE ===");
        
        // Check NFTs around the middle of the range where mature ones might be
        (uint64 nextNftId,,,) = queue.redemptionQueueState();
        
        uint256 pendingMatureAmount = 0;
        
        for (uint256 i = 0; i < nextNftId; i++) {
            (bool hasBeenRedeemed, uint64 maturity, uint120 amount,) = queue.nftInformation(i);
            
            if (!hasBeenRedeemed && amount > 0 && block.timestamp >= maturity) {
                pendingMatureAmount += amount;
            }
        }
        
        console.log("Pending mature amount:", pendingMatureAmount / 1e18, "ETH");
        console.log("Contract ETH:", FRAX_QUEUE.balance / 1e18, "ETH");
        
        // Calculate what happens if all mature NFTs are redeemed
        if (pendingMatureAmount > FRAX_QUEUE.balance) {
            uint256 shortfall = pendingMatureAmount - FRAX_QUEUE.balance;
            console.log("\n!!! BANK RUN SCENARIO !!!");
            console.log("If all mature NFT holders redeem:");
            console.log("  Shortfall:", shortfall / 1e18, "ETH");
            console.log("  USD Value (~$3200/ETH):", (shortfall / 1e18) * 3200);
        }
    }
}
