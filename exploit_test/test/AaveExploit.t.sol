// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
    function allowance(address, address) external view returns (uint256);
}

contract AaveExploitTest is Test {
    address constant AAVE_POOL = 0x87870Bca3F3fD6335C3F4ce8392D69350B4fA4E2;
    address constant wstETH = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
    address constant aWstETH = 0x0B925eD163218f6662a35e0f0371Ac234f9E9371;
    
    address constant STRATEGY_0 = 0x60d2D94aCB969CA54e781007eE89F04c1A2e5943;
    address constant STRATEGY_1 = 0x5aE0e44DE96885702bD99A6914751C952d284938;
    address constant STRATEGY_2 = 0xB27D688Ac06a441c005657971B11521e80CdcE98;
    address constant STRATEGY_3 = 0xbfdF0aF6Df48E645Bd076802B95DDEf0b1E02a9d;
    
    string RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c";

    function setUp() public {
        vm.createSelectFork(RPC_URL);
    }

    function test_CheckAaveApprovals() public view {
        console.log("=== CHECKING AAVE APPROVALS ===\n");
        
        address[4] memory strategies = [STRATEGY_0, STRATEGY_1, STRATEGY_2, STRATEGY_3];
        
        for (uint i = 0; i < strategies.length; i++) {
            console.log("Strategy:", strategies[i]);
            
            uint256 wstETHAllowance = IERC20(wstETH).allowance(strategies[i], AAVE_POOL);
            console.log("wstETH allowance to Aave:", wstETHAllowance);
            
            uint256 aWstETHBalance = IERC20(aWstETH).balanceOf(strategies[i]);
            console.log("aWstETH balance:", aWstETHBalance);
            
            uint256 wstETHBalance = IERC20(wstETH).balanceOf(strategies[i]);
            console.log("wstETH balance:", wstETHBalance);
            
            if (wstETHAllowance == type(uint256).max) {
                console.log("*** MAX APPROVAL TO AAVE ***");
            }
            console.log("---");
        }
    }

    function test_CheckAllProtocolApprovals() public view {
        console.log("=== CHECKING ALL PROTOCOL APPROVALS ===\n");
        
        address[4] memory strategies = [STRATEGY_0, STRATEGY_1, STRATEGY_2, STRATEGY_3];
        
        address[8] memory protocols = [
            AAVE_POOL,
            0xC13e21B648A5Ee794902342038FF3aDAB66BE987, // Spark
            wstETH,
            0x1111111254EEB25477B68fb85Ed929f73A960582, // 1inch
            0xE592427A0AEce92De3Edee1F18E0157C05861564, // Uniswap V3
            0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45, // Uniswap Router 02
            0xDef1C0ded9bec7F1a1670819833240f027b25EfF, // 0x Exchange
            0x551d155760ae96050439AD24Ae98A96c765d761B  // Treehouse Vault
        ];
        
        for (uint s = 0; s < strategies.length; s++) {
            console.log("Strategy:", strategies[s]);
            
            for (uint p = 0; p < protocols.length; p++) {
                uint256 allowance = IERC20(wstETH).allowance(strategies[s], protocols[p]);
                if (allowance > 0) {
                    console.log("  Approved:", protocols[p]);
                    console.log("  Amount:", allowance);
                }
            }
            console.log("---");
        }
    }

    function test_ATokenTransferExploit() public view {
        console.log("=== CHECKING ATOKEN BALANCES ===\n");
        
        address[4] memory strategies = [STRATEGY_0, STRATEGY_1, STRATEGY_2, STRATEGY_3];
        
        for (uint s = 0; s < strategies.length; s++) {
            uint256 aBalance = IERC20(aWstETH).balanceOf(strategies[s]);
            console.log("Strategy:", strategies[s]);
            console.log("  aWstETH balance:", aBalance);
        }
    }
}
