// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

contract UnverifiedProbeTest is Test {
    address constant TARGET1 = 0xC82Abe4dFA94b9B5453d31274Fb7500459a0d12d;  // 9997 ETH
    
    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
    }

    function testAnalyze9997ETHContract() public {
        console.log("=== ANALYZING 9997 ETH CONTRACT ===");
        console.log("Target:", TARGET1);
        console.log("Balance:", TARGET1.balance / 1e18, "ETH");
        console.log("Code size:", TARGET1.code.length);
        
        // Dump first 50 storage slots
        console.log("\n--- Non-zero Storage Slots ---");
        for (uint i = 0; i < 50; i++) {
            bytes32 slot = vm.load(TARGET1, bytes32(i));
            if (uint256(slot) != 0) {
                console.log("Slot", i, "=", uint256(slot));
                // Check if it looks like an address
                address addr = address(uint160(uint256(slot)));
                if (addr.code.length > 0) {
                    console.log("  -> Contract:", addr);
                }
            }
        }
        
        // Extract function selectors from bytecode
        console.log("\n--- Extracting Function Selectors ---");
        bytes memory code = TARGET1.code;
        
        // Look for PUSH4 patterns (0x63) which typically precede function selectors
        uint found = 0;
        for (uint i = 0; i < code.length - 4 && found < 20; i++) {
            if (code[i] == 0x63) {  // PUSH4
                bytes4 selector = bytes4(bytes.concat(code[i+1], code[i+2], code[i+3], code[i+4]));
                // Only show if selector looks reasonable (not all zeros or ones)
                if (uint32(selector) > 0x1000 && uint32(selector) < 0xfffffffe) {
                    console.log("Selector:", vm.toString(selector));
                    found++;
                }
            }
        }
    }

    function testBruteforceSelectors() public {
        console.log("=== BRUTEFORCE COMMON SELECTORS ===");
        
        // Common DeFi function selectors
        bytes4[30] memory sigs = [
            bytes4(keccak256("withdraw()")),           // 0x3ccfd60b
            bytes4(keccak256("withdraw(uint256)")),    // 0x2e1a7d4d
            bytes4(keccak256("withdrawAll()")),        // 0x853828b6
            bytes4(keccak256("claim()")),              // 0x4e71d92d
            bytes4(keccak256("exit()")),               // 0xe9fad8ee
            bytes4(keccak256("getReward()")),          // 0x3d18b912
            bytes4(keccak256("harvest()")),            // 0x4641257d
            bytes4(keccak256("owner()")),              // 0x8da5cb5b
            bytes4(keccak256("admin()")),              // 0xf851a440
            bytes4(keccak256("pendingOwner()")),       // 0xe30c3978
            bytes4(keccak256("totalSupply()")),        // 0x18160ddd
            bytes4(keccak256("balanceOf(address)")),   // 0x70a08231
            bytes4(keccak256("symbol()")),             // 0x95d89b41
            bytes4(keccak256("name()")),               // 0x06fdde03
            bytes4(keccak256("decimals()")),           // 0x313ce567
            bytes4(keccak256("getOwner()")),           // 0x893d20e8
            bytes4(keccak256("owners(uint256)")),      // 0x025e7c27
            bytes4(keccak256("required()")),           // 0xdc8452cd
            bytes4(keccak256("transactionCount()")),   // 0xb77bf600
            bytes4(keccak256("isOwner(address)")),     // 0x2f54bf6e
            bytes4(keccak256("getTransactionCount(bool,bool)")),  // 0x54741525
            bytes4(keccak256("getOwners()")),          // 0xa0e67e2b
            bytes4(keccak256("confirmTransaction(uint256)")),  // 0xc01a8c84
            bytes4(keccak256("submitTransaction(address,uint256,bytes)")),  // 0xc6427474
            bytes4(keccak256("executeTransaction(uint256)")),  // 0xee22610b
            bytes4(keccak256("getTransactionIds(uint256,uint256,bool,bool)")),  // 0xa8abe69a
            bytes4(keccak256("getConfirmationCount(uint256)")),  // 0x8b51d13f
            bytes4(keccak256("getConfirmations(uint256)")),  // 0xb5dc40c3
            bytes4(keccak256("isConfirmed(uint256)")),  // 0x784547a7
            bytes4(keccak256("transactions(uint256)"))  // 0x9ace38c2
        ];
        
        for (uint i = 0; i < sigs.length; i++) {
            (bool success, bytes memory data) = TARGET1.staticcall(abi.encodeWithSelector(sigs[i]));
            if (success && data.length > 0) {
                console.log("Found:", vm.toString(sigs[i]));
                if (data.length == 32) {
                    uint256 val = abi.decode(data, (uint256));
                    console.log("  Result:", val);
                }
            }
        }
    }

    receive() external payable {}
}
