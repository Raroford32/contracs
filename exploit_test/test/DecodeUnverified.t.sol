// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

interface IProxy {
    function implementation() external view returns (address);
    function admin() external view returns (address);
}

contract DecodeUnverifiedTest is Test {
    address constant TARGET = 0xC82Abe4dFA94b9B5453d31274Fb7500459a0d12d;
    
    // ERC1967 slots
    bytes32 constant IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;
    bytes32 constant ADMIN_SLOT = 0xb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103;
    bytes32 constant BEACON_SLOT = 0xa3f0ad74e5423aebfd80d3ef4346578335a9a72aeaee59ff6cb3582b35133d50;

    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
    }

    function testDecodeProxy() public view {
        console.log("=== DECODE UNVERIFIED CONTRACT ===");
        console.log("Target:", TARGET);
        console.log("Balance:", TARGET.balance / 1e18, "ETH");
        console.log("Code size:", TARGET.code.length);

        // Check ERC1967 slots
        bytes32 implSlotValue = vm.load(TARGET, IMPLEMENTATION_SLOT);
        bytes32 adminSlotValue = vm.load(TARGET, ADMIN_SLOT);
        bytes32 beaconSlotValue = vm.load(TARGET, BEACON_SLOT);

        console.log("\nERC1967 Proxy Slots:");
        console.log("Implementation slot:", vm.toString(implSlotValue));
        console.log("Admin slot:", vm.toString(adminSlotValue));
        console.log("Beacon slot:", vm.toString(beaconSlotValue));

        address impl = address(uint160(uint256(implSlotValue)));
        address admin = address(uint160(uint256(adminSlotValue)));
        address beacon = address(uint160(uint256(beaconSlotValue)));

        console.log("\nDecoded addresses:");
        console.log("Implementation:", impl);
        console.log("Admin:", admin);
        console.log("Beacon:", beacon);

        if (impl != address(0)) {
            console.log("\nImplementation code size:", impl.code.length);
        }

        // Try common view functions
        console.log("\nTrying common function calls...");
        
        // Check first few storage slots
        console.log("\nFirst storage slots:");
        for (uint i = 0; i < 5; i++) {
            bytes32 slot = vm.load(TARGET, bytes32(i));
            if (uint256(slot) != 0) {
                console.log("Slot", i, ":", vm.toString(slot));
            }
        }
    }
}
