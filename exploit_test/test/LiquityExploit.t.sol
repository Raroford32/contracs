// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
    function approve(address, uint256) external returns (bool);
    function transfer(address, uint256) external returns (bool);
    function decimals() external view returns (uint8);
}

interface IChainlinkAggregator {
    function latestRoundData() external view returns (
        uint80 roundId,
        int256 answer,
        uint256 startedAt,
        uint256 updatedAt,
        uint80 answeredInRound
    );
    function decimals() external view returns (uint8);
}

interface IBAMM {
    function swap(uint256 thusdAmount, uint256 minCollateralReturn, address payable dest) external returns (uint256);
    function getSwapCollateralAmount(uint256 thusdQty) external view returns (uint256 collateralAmount);
    function fetchPrice() external view returns (uint256 collateralPrice, uint256 thusdPrice);
    function thusdToken() external view returns (address);
    function collateral() external view returns (address);
}

/**
 * @title Liquity BAMM Oracle Staleness Exploit
 * @notice Check if oracle is stale and exploit is possible
 */
contract LiquityExploitTest is Test {
    // BAMM contract from Liquity
    address constant BAMM = 0x097f1ee62E63aCFC3Bf64c1a61d96B3771dd06cB;

    // Chainlink ETH/USD oracle
    address constant ETH_USD_ORACLE = 0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419;

    IBAMM bamm;
    IChainlinkAggregator oracle;

    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
        bamm = IBAMM(BAMM);
        oracle = IChainlinkAggregator(ETH_USD_ORACLE);
    }

    function testOracleStalenessCheck() public view {
        console.log("=== ORACLE STALENESS CHECK ===");

        (
            uint80 roundId,
            int256 answer,
            ,
            uint256 updatedAt,
            uint80 answeredInRound
        ) = oracle.latestRoundData();

        uint256 staleness = block.timestamp - updatedAt;

        console.log("Block timestamp:", block.timestamp);
        console.log("Oracle updated at:", updatedAt);
        console.log("Staleness (seconds):", staleness);
        console.log("Staleness (minutes):", staleness / 60);
        console.log("ETH price:", uint256(answer) / 1e8);
        console.log("Round ID:", roundId);
        console.log("Answered in round:", answeredInRound);

        if (staleness > 3600) {
            console.log("\n[CRITICAL] ORACLE IS STALE > 1 HOUR!");
            console.log("BAMM swap will return 0 prices - potential exploit!");
        } else {
            console.log("\nOracle is fresh - no stale oracle exploit possible");
        }
    }

    function testBAMMPrices() public view {
        console.log("\n=== BAMM PRICE CHECK ===");

        try bamm.fetchPrice() returns (uint256 collPrice, uint256 thusdPrice) {
            console.log("Collateral price:", collPrice);
            console.log("THUSD price:", thusdPrice);

            if (collPrice == 0 || thusdPrice == 0) {
                console.log("\n[!] ZERO PRICES RETURNED");
                console.log("This indicates stale oracle or error condition");
            }
        } catch {
            console.log("fetchPrice() reverted");
        }
    }

    function testSwapSimulation() public view {
        console.log("\n=== SWAP SIMULATION ===");

        // Check how much collateral for 1000 THUSD
        uint256 thusdAmount = 1000e18;

        try bamm.getSwapCollateralAmount(thusdAmount) returns (uint256 collateral) {
            console.log("Input THUSD:", thusdAmount / 1e18);
            console.log("Output collateral:", collateral);

            // Check if profitable
            (uint256 collPrice, uint256 thusdPrice) = bamm.fetchPrice();
            if (collPrice > 0 && collateral > 0) {
                uint256 collValueUSD = (collateral * collPrice) / 1e18;
                console.log("Collateral value (USD):", collValueUSD / 1e18);
                console.log("THUSD input value (USD):", thusdAmount / 1e18);

                if (collValueUSD > thusdAmount) {
                    console.log("\n[!] PROFITABLE SWAP DETECTED!");
                    console.log("Profit:", (collValueUSD - thusdAmount) / 1e18, "USD");
                }
            }
        } catch {
            console.log("getSwapCollateralAmount() reverted");
        }
    }
}
