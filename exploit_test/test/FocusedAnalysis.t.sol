// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
    function totalSupply() external view returns (uint256);
}

contract FocusedAnalysis is Test {
    address constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address constant CHZ = 0x3506424F91fD33084466F402d5D97f05F8e3b4AF;
    address constant THUSD = 0xCFC5bD99915aAa815401C5a41A927aB7a38d29cf;
    address constant ACX = 0x44108f0223A3C3028F5Fe7AEC7f9bb2E66beF82F;

    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
    }

    function testHighValueContracts() public view {
        console.log("=====================================================");
        console.log("HIGH VALUE CONTRACT ANALYSIS");
        console.log("=====================================================");

        // StakingRewards - steCRV LP tokens
        console.log("\n--- StakingRewards (0x4F48...) ---");
        address stakingRewards = 0x4F48031B0EF8acCea3052Af00A3279fbA31b50D8;
        (bool success, bytes memory data) = stakingRewards.staticcall(abi.encodeWithSignature("stakingToken()"));
        if (success && data.length >= 32) {
            address stakingToken = abi.decode(data, (address));
            uint256 stakedBal = IERC20(stakingToken).balanceOf(stakingRewards);
            console.log("Staking Token:", stakingToken);
            console.log("Staked Balance:", stakedBal / 1e18, "LP");
            console.log("Est. Value: ~$", stakedBal * 3200 / 1e18); // ~$3200/LP rough estimate
        }

        // ERC20Handler - CHZ tokens
        console.log("\n--- ERC20Handler (0x2F1d...) ---");
        address handler = 0x2F1d2754393356AEA6334180DA04BAB84412D580;
        uint256 chzBal = IERC20(CHZ).balanceOf(handler);
        console.log("CHZ Balance:", chzBal / 1e18);
        console.log("Est. Value: ~$", chzBal * 5 / 100 / 1e18); // ~$0.05 per CHZ

        // PCV Controller - THUSD
        console.log("\n--- PCV Controller (0x097f...) ---");
        address pcv = 0x097f1ee62E63aCFC3Bf64c1a61d96B3771dd06cB;
        uint256 thusdBal = IERC20(THUSD).balanceOf(pcv);
        console.log("THUSD Balance:", thusdBal / 1e18);
        console.log("Est. Value: ~$", thusdBal / 1e18); // $1 per THUSD

        // Check ACX (AcceleratingDistributor)
        console.log("\n--- Looking for AcceleratingDistributor ---");
        // Common AcceleratingDistributor addresses from Across protocol
        address[3] memory accelAddrs = [
            0x9040e41eF5E8b281535a96D9a48aCb8cfaBD9a48,
            0x7b292034084A41B9D441B71b6E3557Edd0463fa8,
            0x44108f0223A3C3028F5Fe7AEC7f9bb2E66beF82F
        ];

        for (uint i = 0; i < accelAddrs.length; i++) {
            if (accelAddrs[i].code.length > 0) {
                uint256 acxBal = IERC20(ACX).balanceOf(accelAddrs[i]);
                if (acxBal > 0) {
                    console.log("Found ACX at:", accelAddrs[i]);
                    console.log("ACX Balance:", acxBal / 1e18);
                }
            }
        }

        // BAMM analysis
        console.log("\n--- Actual BAMM (0x9206...) ---");
        address actualBamm = 0x920623AcBa785ED9a70d33ACab53631e1e834675;
        _analyzeBamm(actualBamm);
    }

    function _analyzeBamm(address bamm) internal view {
        // Read SP
        (bool success, bytes memory data) = bamm.staticcall(abi.encodeWithSignature("SP()"));
        if (success && data.length >= 32) {
            address sp = abi.decode(data, (address));
            console.log("Stability Pool:", sp);

            // Get THUSD in SP
            (bool spSuccess, bytes memory spData) = sp.staticcall(
                abi.encodeWithSignature("getCompoundedTHUSDDeposit(address)", bamm)
            );
            if (spSuccess && spData.length >= 32) {
                uint256 thusdInSp = abi.decode(spData, (uint256));
                console.log("THUSD in SP:", thusdInSp / 1e18);
            }

            // Get collateral gain
            (bool collSuccess, bytes memory collData) = sp.staticcall(
                abi.encodeWithSignature("getDepositorCollateralGain(address)", bamm)
            );
            if (collSuccess && collData.length >= 32) {
                uint256 collGain = abi.decode(collData, (uint256));
                console.log("Collateral Gain:", collGain / 1e18);
            }
        }

        // Get price
        (success, data) = bamm.staticcall(abi.encodeWithSignature("fetchPrice()"));
        if (success && data.length >= 32) {
            uint256 price = abi.decode(data, (uint256));
            console.log("ETH Price:", price / 1e18);
        }
    }

    function testSummary() public pure {
        console.log("=====================================================");
        console.log("EXPLOIT ANALYSIS SUMMARY");
        console.log("=====================================================");

        console.log("\n[1] BAMM PriceFormula Math Vulnerability");
        console.log("    Status: CONFIRMED in isolated formula");
        console.log("    Condition: Requires y/x ratio > 1 (high collateral)");
        console.log("    Current State: Pool balanced (0 collateral gain)");
        console.log("    Profit Potential:");
        console.log("      - Ratio 2:1 -> 19.45% profit");
        console.log("      - Ratio 5:1 -> 71% profit");
        console.log("      - Ratio 10:1 -> 206% profit");
        console.log("    Trigger: Major liquidation event");
        console.log("    Max Extractable: ~$4M (at current TVL)");

        console.log("\n[2] StakingRewards");
        console.log("    Status: PROTECTED");
        console.log("    Reason: Rewards expired, time-weighted earning");

        console.log("\n[3] ERC20Handler (ChainBridge)");
        console.log("    Status: PROTECTED");
        console.log("    Reason: onlyBridge modifier on all functions");

        console.log("\n[4] PCV Controller");
        console.log("    Status: PROTECTED");
        console.log("    Reason: onlyOwner/governance controls");

        console.log("\n=====================================================");
        console.log("CONCLUSION: No immediately executable exploits found");
        console.log("BAMM vulnerability exists but requires market event");
        console.log("=====================================================");
    }
}
