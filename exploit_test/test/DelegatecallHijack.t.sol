// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
    function transfer(address, uint256) external returns (bool);
    function approve(address, uint256) external returns (bool);
    function transferFrom(address, address, uint256) external returns (bool);
}

contract DelegatecallHijack is Test {
    address constant REDEMPTION_CONTROLLER = 0xdF2eE409BEe416A53b5C040d8e6dAD4a7cEb2510;
    address constant REDEMPTION_0 = 0xcd63a29FAfF07130d3Af89bB4f40778938AaBB85;
    address constant REDEMPTION_1 = 0x829525417Cd78CBa0f99A8736426fC299506C0d6;
    address constant VAULT = 0x551d155760ae96050439AD24Ae98A96c765d761B;
    address constant wstETH = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
    address constant IAU = 0x1B6238E95bBCABEE58997c99BaDD4154ad68BA92;

    string RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c";
    address attacker;

    function setUp() public {
        vm.createSelectFork(RPC_URL);
        attacker = makeAddr("attacker");
        vm.deal(attacker, 100 ether);
    }

    function test_FindRCRegisteredRedemptions() public view {
        console.log("=== FINDING RC REGISTERED REDEMPTIONS ===\n");

        // Let's find where the redemption whitelist is stored
        // Try mapping(address => bool) pattern at different slots

        for (uint base = 0; base < 10; base++) {
            // Standard mapping hash
            bytes32 key0 = keccak256(abi.encode(REDEMPTION_0, base));
            bytes32 value0 = vm.load(REDEMPTION_CONTROLLER, key0);
            
            bytes32 key1 = keccak256(abi.encode(REDEMPTION_1, base));
            bytes32 value1 = vm.load(REDEMPTION_CONTROLLER, key1);

            if (value0 != bytes32(0) || value1 != bytes32(0)) {
                console.log("Base slot", base, ":");
                console.log("  Redemption 0 value:");
                console.logBytes32(value0);
                console.log("  Redemption 1 value:");
                console.logBytes32(value1);
            }
        }

        // Also try with packed addresses (uint160)
        console.log("\nTrying with uint160 packing:");
        for (uint base = 0; base < 10; base++) {
            bytes32 key0 = keccak256(abi.encode(uint256(uint160(REDEMPTION_0)), base));
            bytes32 value0 = vm.load(REDEMPTION_CONTROLLER, key0);
            
            if (value0 != bytes32(0)) {
                console.log("Base slot", base, "found!");
                console.logBytes32(value0);
            }
        }
    }

    function test_CallViewFunctionsOnRC() public view {
        console.log("=== CALLING RC VIEW FUNCTIONS ===\n");

        // Try getRedemptionContracts()
        (bool success, bytes memory data) = REDEMPTION_CONTROLLER.staticcall(
            abi.encodeWithSignature("getRedemptionContracts()")
        );
        if (success) {
            console.log("getRedemptionContracts() returned", data.length, "bytes");
            address[] memory redemptions = abi.decode(data, (address[]));
            console.log("Number of redemption contracts:", redemptions.length);
            for (uint i = 0; i < redemptions.length; i++) {
                console.log("  ", i, ":", redemptions[i]);
            }
        }

        // Try redemptions(address)
        (success, data) = REDEMPTION_CONTROLLER.staticcall(
            abi.encodeWithSignature("redemptions(address)", REDEMPTION_0)
        );
        if (success && data.length == 32) {
            bool isRegistered = abi.decode(data, (bool));
            console.log("\nredemptions(REDEMPTION_0):", isRegistered);
        }

        // Try isRedemption
        (success, data) = REDEMPTION_CONTROLLER.staticcall(
            abi.encodeWithSignature("isRedemption(address)", REDEMPTION_0)
        );
        if (success && data.length == 32) {
            bool isRed = abi.decode(data, (bool));
            console.log("isRedemption(REDEMPTION_0):", isRed);
        }
    }

    function test_FindRCFunctionSelectors() public view {
        console.log("=== FINDING RC FUNCTION SELECTORS ===\n");

        bytes memory code = REDEMPTION_CONTROLLER.code;
        console.log("RC code size:", code.length);

        // Find all PUSH4 followed by EQ (function selector checks)
        console.log("Function selectors in RC:");

        uint count = 0;
        for (uint i = 0; i + 5 < code.length; i++) {
            if (uint8(code[i]) == 0x63) { // PUSH4
                bytes4 selector = bytes4(bytes.concat(code[i+1], code[i+2], code[i+3], code[i+4]));

                for (uint j = i + 5; j < i + 15 && j < code.length; j++) {
                    if (uint8(code[j]) == 0x14) { // EQ
                        console.logBytes4(selector);
                        count++;
                        break;
                    }
                }
            }
        }
        console.log("\nTotal selectors found:", count);
    }

    function test_TryRCSelectorsAsView() public view {
        console.log("=== TRYING RC SELECTORS AS VIEW ===\n");

        // Known selectors we might have
        bytes4[] memory selectors = new bytes4[](20);
        selectors[0] = bytes4(keccak256("owner()"));
        selectors[1] = bytes4(keccak256("paused()"));
        selectors[2] = bytes4(keccak256("UNDERLYING()"));
        selectors[3] = bytes4(keccak256("VAULT()"));
        selectors[4] = bytes4(keccak256("pendingOwner()"));
        selectors[5] = bytes4(keccak256("getRedemptionContracts()"));
        selectors[6] = bytes4(keccak256("redemptions(address)"));
        selectors[7] = bytes4(keccak256("isRedemption(address)"));
        selectors[8] = bytes4(keccak256("implementation()"));
        selectors[9] = bytes4(keccak256("proxiableUUID()"));

        string[10] memory names = [
            "owner",
            "paused",
            "UNDERLYING",
            "VAULT",
            "pendingOwner",
            "getRedemptionContracts",
            "redemptions",
            "isRedemption",
            "implementation",
            "proxiableUUID"
        ];

        for (uint i = 0; i < 10; i++) {
            bytes memory callData;
            if (i == 6 || i == 7) {
                callData = abi.encodeWithSelector(selectors[i], REDEMPTION_0);
            } else {
                callData = abi.encodeWithSelector(selectors[i]);
            }

            (bool success, bytes memory data) = REDEMPTION_CONTROLLER.staticcall(callData);
            if (success && data.length > 0) {
                console.log(names[i], "():");
                if (data.length == 32) {
                    bytes32 result = abi.decode(data, (bytes32));
                    if (uint256(result) < 1000) {
                        console.log("  ", uint256(result));
                    } else {
                        console.logBytes32(result);
                    }
                } else if (data.length == 20) {
                    address addr = abi.decode(data, (address));
                    console.log("  ", addr);
                }
            }
        }
    }

    function test_AnalyzeSlot5Address() public view {
        console.log("=== ANALYZING SLOT 5 ADDRESS ===\n");

        // Slot 5 in RC contains: 0xef69713f639130b6f0d4a12a11e2169a4d1bd52a
        address slot5Addr = 0xEf69713F639130B6F0D4A12a11E2169a4d1bD52a;

        console.log("Address at slot 5:", slot5Addr);
        console.log("Code size:", slot5Addr.code.length);

        if (slot5Addr.code.length > 0) {
            bytes memory code = slot5Addr.code;

            // Count opcodes
            uint256 delegatecallCount = 0;
            uint256 callCount = 0;

            for (uint i = 0; i < code.length; i++) {
                if (uint8(code[i]) == 0xf4) delegatecallCount++;
                if (uint8(code[i]) == 0xf1) callCount++;
            }

            console.log("DELEGATECALL:", delegatecallCount);
            console.log("CALL:", callCount);

            // Check for common selectors
            bytes4 transferSel = bytes4(0xa9059cbb);
            bytes4 transferFromSel = bytes4(0x23b872dd);

            for (uint i = 0; i + 3 < code.length; i++) {
                bytes4 sel = bytes4(bytes.concat(code[i], code[i+1], code[i+2], code[i+3]));
                if (sel == transferSel) {
                    console.log("Has transfer selector at:", i);
                }
                if (sel == transferFromSel) {
                    console.log("Has transferFrom selector at:", i);
                }
            }
        }
    }
}
