// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
    function approve(address, uint256) external returns (bool);
    function transfer(address, uint256) external returns (bool);
}

contract RCCreate2Registration is Test {
    address constant REDEMPTION_0 = 0xcd63a29FAfF07130d3Af89bB4f40778938AaBB85;
    address constant REDEMPTION_1 = 0x829525417Cd78CBa0f99A8736426fC299506C0d6;
    address constant REDEMPTION_CONTROLLER = 0xdF2eE409BEe416A53b5C040d8e6dAD4a7cEb2510;
    address constant VAULT = 0x551d155760ae96050439AD24Ae98A96c765d761B;
    address constant wstETH = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
    address constant TASSET = 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8;

    bytes32 constant INIT_CODE_HASH_R1 = 0xa7afdc89189c0997287e337d2577f5aa7f1fa2faecf74ac9e05b6fdc306bfcd6;
    bytes32 constant INIT_CODE_HASH_RC = 0x1957f86c1404226d17452b1fce2398f5b1682d57054777140d7a9fb757caa99e;

    string RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c";
    address attacker;

    function setUp() public {
        vm.createSelectFork(RPC_URL);
        attacker = makeAddr("attacker");
        vm.deal(attacker, 100 ether);
    }

    function test_AnalyzeRCCreate2Operations() public view {
        console.log("=== ANALYZING RC CREATE2 OPERATIONS ===\n");

        bytes memory code = REDEMPTION_CONTROLLER.code;

        // RC has CREATE2 at offsets 759, 1158, 1641
        console.log("Analyzing CREATE2 at offset 759:");
        _traceAroundOffset(code, 759, 50);

        console.log("\n\nAnalyzing CREATE2 at offset 1158:");
        _traceAroundOffset(code, 1158, 50);

        console.log("\n\nAnalyzing CREATE2 at offset 1641:");
        _traceAroundOffset(code, 1641, 50);
    }

    function _traceAroundOffset(bytes memory code, uint target, uint range) internal pure {
        uint start = target > range ? target - range : 0;
        uint end = target + range < code.length ? target + range : code.length;

        for (uint i = start; i < end; i++) {
            uint8 op = uint8(code[i]);

            if (op == 0x5b) console.log(i, "JUMPDEST");
            if (op == 0x33) console.log(i, "CALLER");
            if (op == 0x54) console.log(i, "SLOAD");
            if (op == 0x55) console.log(i, "SSTORE");
            if (op == 0xf5) console.log(i, "*** CREATE2 ***");
            if (op == 0x20) console.log(i, "SHA3");

            if (op >= 0x60 && op <= 0x7f) {
                uint8 size = op - 0x5f;
                uint256 val = 0;
                for (uint j = 0; j < size && i + 1 + j < code.length; j++) {
                    val = val << 8 | uint8(code[i + 1 + j]);
                }
                if (size == 32) {
                    console.log(i, "PUSH32:");
                    console.logBytes32(bytes32(val));
                } else if (val < 10000) {
                    console.log(i, "PUSH:", val);
                }
            }
        }
    }

    function test_DoesCreate2RegisterInMapping() public view {
        console.log("=== DOES CREATE2 REGISTER DEPLOYED CONTRACT? ===\n");

        bytes memory code = REDEMPTION_CONTROLLER.code;

        // Look for SSTORE after CREATE2 - if it stores to the registration mapping,
        // then CREATE2-deployed contracts are automatically registered

        console.log("Looking for SSTORE after CREATE2 at 759:");
        for (uint i = 759; i < 850 && i < code.length; i++) {
            if (uint8(code[i]) == 0x55) {
                console.log("SSTORE at:", i);
            }
            if (uint8(code[i]) == 0x20) {
                console.log("SHA3 at:", i);
            }
        }

        console.log("\nLooking for SSTORE after CREATE2 at 1158:");
        for (uint i = 1158; i < 1250 && i < code.length; i++) {
            if (uint8(code[i]) == 0x55) {
                console.log("SSTORE at:", i);
            }
            if (uint8(code[i]) == 0x20) {
                console.log("SHA3 at:", i);
            }
        }

        console.log("\nLooking for SSTORE after CREATE2 at 1641:");
        for (uint i = 1641; i < 1750 && i < code.length; i++) {
            if (uint8(code[i]) == 0x55) {
                console.log("SSTORE at:", i);
            }
            if (uint8(code[i]) == 0x20) {
                console.log("SHA3 at:", i);
            }
        }
    }

    function test_FindRCSelectors() public view {
        console.log("=== FINDING RC SELECTORS ===\n");

        bytes memory code = REDEMPTION_CONTROLLER.code;

        bytes4[] memory found = new bytes4[](30);
        uint count = 0;

        for (uint i = 0; i + 10 < 500 && i < code.length && count < 30; i++) {
            if (uint8(code[i]) == 0x63) {
                bytes4 sel = bytes4(bytes.concat(code[i+1], code[i+2], code[i+3], code[i+4]));
                bool hasEq = false;
                for (uint j = i + 5; j < i + 15 && j < code.length; j++) {
                    if (uint8(code[j]) == 0x14) hasEq = true;
                }
                if (hasEq && uint32(sel) > 0x1000) {
                    bool unique = true;
                    for (uint k = 0; k < count; k++) {
                        if (found[k] == sel) unique = false;
                    }
                    if (unique) {
                        found[count] = sel;
                        count++;
                    }
                }
            }
        }

        console.log("RC Selectors:");
        for (uint i = 0; i < count; i++) {
            console.logBytes4(found[i]);
        }
    }

    function test_TryRCFunctionsToTriggerCreate2() public {
        console.log("=== TRYING RC FUNCTIONS TO TRIGGER CREATE2 ===\n");

        // Predict CREATE2 address if deployed by RC with attacker as salt
        bytes32 salt = bytes32(uint256(uint160(attacker)));
        address predictedRC = address(uint160(uint256(keccak256(abi.encodePacked(
            bytes1(0xff),
            REDEMPTION_CONTROLLER,
            salt,
            INIT_CODE_HASH_RC
        )))));

        console.log("Predicted (RC deployer, attacker salt):", predictedRC);
        console.log("Code before:", predictedRC.code.length);

        // Try RC selectors
        bytes4[] memory sels = new bytes4[](20);
        sels[0] = bytes4(0x7bde82f2); // redeem
        sels[1] = bytes4(0x1fe923d3); // addRedemption
        sels[2] = bytes4(0xb2118a8d);
        sels[3] = bytes4(0x2ab60045);
        sels[4] = bytes4(0x2d88af4a);
        sels[5] = bytes4(0x578063c5);
        sels[6] = bytes4(0x93d5f4c5);
        sels[7] = bytes4(0x9fd0506d);
        sels[8] = bytes4(0xa5956078);
        sels[9] = bytes4(0x411557d1);
        sels[10] = bytes4(0x04824e70);
        sels[11] = bytes4(keccak256("deploy()"));
        sels[12] = bytes4(keccak256("deploy(bytes32)"));
        sels[13] = bytes4(keccak256("createRedemption()"));
        sels[14] = bytes4(keccak256("createRedemption(address)"));
        sels[15] = bytes4(keccak256("deployRedemption()"));
        sels[16] = bytes4(keccak256("deployRedemption(address)"));
        sels[17] = bytes4(keccak256("newRedemption()"));
        sels[18] = bytes4(keccak256("register()"));
        sels[19] = bytes4(keccak256("initialize()"));

        vm.startPrank(attacker);

        for (uint i = 0; i < 20; i++) {
            // Try with no params
            (bool s1,) = REDEMPTION_CONTROLLER.call{gas: 500000}(
                abi.encodeWithSelector(sels[i])
            );

            // Try with address param
            (bool s2,) = REDEMPTION_CONTROLLER.call{gas: 500000}(
                abi.encodeWithSelector(sels[i], attacker)
            );

            if (s1 || s2) {
                console.log("SUCCESS:");
                console.logBytes4(sels[i]);
            }
        }

        vm.stopPrank();

        console.log("\nCode after:", predictedRC.code.length);

        // Check if anything got registered
        bytes32 key = keccak256(abi.encode(predictedRC, uint256(4)));
        bytes32 val = vm.load(REDEMPTION_CONTROLLER, key);
        if (val != bytes32(0)) {
            console.log("*** PREDICTED ADDRESS IS REGISTERED! ***");
        }
    }

    function test_WhatCreates2CanCreate() public view {
        console.log("=== WHAT CAN CREATE2 CREATE? ===\n");

        // The CREATE2 operations in RC might create:
        // 1. New Redemption contracts (like R0, R1)
        // 2. User-specific claim proxies
        // 3. Something else

        // Let's check if existing deployed addresses match CREATE2 predictions

        // Check if R0 was deployed by RC via CREATE2
        console.log("Checking if R0 was deployed by RC:");

        // Try different salts
        for (uint i = 0; i < 10; i++) {
            bytes32 salt = bytes32(i);
            address predicted = address(uint160(uint256(keccak256(abi.encodePacked(
                bytes1(0xff),
                REDEMPTION_CONTROLLER,
                salt,
                INIT_CODE_HASH_RC
            )))));
            if (predicted == REDEMPTION_0) {
                console.log("R0 matches salt:", i);
            }
            if (predicted == REDEMPTION_1) {
                console.log("R1 matches salt:", i);
            }
        }

        // Try deployer-based salts
        address[] memory deployers = new address[](5);
        deployers[0] = 0x2225DAbFfC7F862c99477381E971E8B1FDaB467e; // Owner
        deployers[1] = REDEMPTION_CONTROLLER;
        deployers[2] = VAULT;
        deployers[3] = REDEMPTION_0;
        deployers[4] = REDEMPTION_1;

        console.log("\nTrying deployer-based salts:");
        for (uint d = 0; d < 5; d++) {
            bytes32 salt = bytes32(uint256(uint160(deployers[d])));
            address predicted = address(uint160(uint256(keccak256(abi.encodePacked(
                bytes1(0xff),
                REDEMPTION_CONTROLLER,
                salt,
                INIT_CODE_HASH_RC
            )))));
            if (predicted == REDEMPTION_0) {
                console.log("R0 matches deployer", d);
            }
            if (predicted == REDEMPTION_1) {
                console.log("R1 matches deployer", d);
            }
        }
    }
}
