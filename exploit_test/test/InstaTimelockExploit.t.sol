// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

interface IInstaTimelock {
    function delay() external view returns (uint256);
    function admin() external view returns (address);
    function guardian() external view returns (address);
    function pendingAdmin() external view returns (address);
    function queuedTransactions(bytes32) external view returns (bool);
    function GRACE_PERIOD() external view returns (uint256);
    function MINIMUM_DELAY() external view returns (uint256);
    function MAXIMUM_DELAY() external view returns (uint256);
}

/**
 * @title InstaTimelock Zero Delay Exploit PoC
 * @notice This test demonstrates the zero delay initialization vulnerability:
 * 1. Contract initializes with delay = 0
 * 2. Admin can queue and execute transactions immediately
 * 3. No waiting period protection until setDelay() is called
 *
 * Attack scenario:
 * - If admin key is compromised before delay is set
 * - Attacker can drain funds instantly without timelock protection
 */
contract InstaTimelockExploitTest is Test {
    address constant INSTA_TIMELOCK = 0x2386DC45AdDed673317eF068992F19421B481F4c;

    IInstaTimelock timelock;

    function setUp() public {
        vm.createSelectFork("https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c");
        timelock = IInstaTimelock(INSTA_TIMELOCK);
    }

    function testCurrentState() public view {
        console.log("=== InstaTimelock Current State ===");
        console.log("delay:", timelock.delay());
        console.log("admin:", timelock.admin());
        console.log("guardian:", timelock.guardian());
        console.log("pendingAdmin:", timelock.pendingAdmin());
        console.log("GRACE_PERIOD:", timelock.GRACE_PERIOD());
        console.log("MINIMUM_DELAY:", timelock.MINIMUM_DELAY());
        console.log("MAXIMUM_DELAY:", timelock.MAXIMUM_DELAY());

        // Check if delay is zero - immediate execution possible
        if (timelock.delay() == 0) {
            console.log("\n[CRITICAL] Delay is ZERO - immediate transaction execution possible!");
            console.log("Admin can queue and execute malicious transactions without any waiting period");
        } else {
            console.log("\nDelay is set to:", timelock.delay() / 1 days, "days");
        }
    }

    function testZeroDelayExploitVector() public view {
        uint256 currentDelay = timelock.delay();

        console.log("\n=== Zero Delay Exploit Analysis ===");

        if (currentDelay == 0) {
            console.log("[!] EXPLOIT VECTOR ACTIVE:");
            console.log("1. Attacker compromises admin key");
            console.log("2. Attacker queues malicious transaction with eta = block.timestamp");
            console.log("3. Attacker executes transaction immediately");
            console.log("4. No timelock protection - funds drained instantly");
            console.log("\nThis bypasses the entire timelock security model!");
        } else {
            console.log("Delay is configured:", currentDelay, "seconds");
            console.log("Timelock protection is active");
            console.log("Minimum wait time before execution:", currentDelay / 3600, "hours");
        }
    }
}
