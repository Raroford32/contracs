// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
    function approve(address, uint256) external returns (bool);
}

contract FindCreate2Path is Test {
    address constant REDEMPTION_0 = 0xcd63a29FAfF07130d3Af89bB4f40778938AaBB85;
    address constant REDEMPTION_1 = 0x829525417Cd78CBa0f99A8736426fC299506C0d6;
    address constant REDEMPTION_CONTROLLER = 0xdF2eE409BEe416A53b5C040d8e6dAD4a7cEb2510;
    address constant VAULT = 0x551d155760ae96050439AD24Ae98A96c765d761B;
    address constant wstETH = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
    address constant TASSET = 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8;

    bytes32 constant INIT_CODE_HASH = 0xa7afdc89189c0997287e337d2577f5aa7f1fa2faecf74ac9e05b6fdc306bfcd6;

    string RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c";
    address attacker;

    function setUp() public {
        vm.createSelectFork(RPC_URL);
        attacker = makeAddr("attacker");
        vm.deal(attacker, 100 ether);
    }

    function test_TraceCreate2At5608() public view {
        console.log("=== TRACING CODE AT CREATE2 OFFSET 5608 ===\n");

        bytes memory code = REDEMPTION_0.code;

        // Let's see exactly what's at 5608
        console.log("Opcodes from 5600 to 5650:");

        uint i = 5600;
        while (i < 5650 && i < code.length) {
            uint8 op = uint8(code[i]);
            uint skipBytes = 0;

            string memory opName = "";
            if (op == 0xf5) opName = "*** CREATE2 ***";
            if (op == 0x56) opName = "JUMP";
            if (op == 0x57) opName = "JUMPI";
            if (op == 0x5b) opName = "JUMPDEST";
            if (op == 0x33) opName = "CALLER";
            if (op == 0x54) opName = "SLOAD";

            if (bytes(opName).length > 0) {
                console.log(i, opName);
            }

            if (op >= 0x60 && op <= 0x7f) {
                uint8 size = op - 0x5f;
                uint256 val = 0;
                for (uint j = 0; j < size && i + 1 + j < code.length; j++) {
                    val = val << 8 | uint8(code[i + 1 + j]);
                }
                if (size == 32) {
                    console.log(i, "PUSH32:");
                    console.logBytes32(bytes32(val));
                } else if (val < 10000) {
                    console.log(i, "PUSH:", val);
                }
                skipBytes = size;
            }

            i += 1 + skipBytes;
        }
    }

    function test_TraceBackwardsFromCreate2() public view {
        console.log("=== TRACING BACKWARDS FROM CREATE2 ===\n");

        bytes memory code = REDEMPTION_0.code;

        // Find what calls the code containing CREATE2 at 5608
        // by looking for JUMPs to nearby JUMPDESTs

        // Find nearest JUMPDEST before 5608
        uint nearestJD = 0;
        for (uint i = 5500; i < 5608 && i < code.length; i++) {
            if (uint8(code[i]) == 0x5b) nearestJD = i;
        }
        console.log("Nearest JUMPDEST before CREATE2:", nearestJD);

        // Find what pushes this JUMPDEST
        console.log("\nSearching for jumps to", nearestJD, ":");

        for (uint i = 0; i < code.length - 3; i++) {
            if (uint8(code[i]) == 0x61) { // PUSH2
                uint16 dest = uint16(uint8(code[i+1])) << 8 | uint8(code[i+2]);
                if (dest == nearestJD) {
                    console.log("PUSH2", nearestJD, "at offset:", i);

                    // Check context
                    uint8 afterOp = 0;
                    for (uint j = i + 3; j < i + 10 && j < code.length; j++) {
                        afterOp = uint8(code[j]);
                        if (afterOp == 0x56 || afterOp == 0x57) {
                            console.log("  followed by:", afterOp == 0x56 ? "JUMP" : "JUMPI", "at", j);
                            break;
                        }
                    }
                }
            }
        }
    }

    function test_MatchSelectorsFromR0Dispatcher() public view {
        console.log("=== MATCHING R0 DISPATCHER SELECTORS ===\n");

        bytes memory code = REDEMPTION_0.code;

        // The dispatcher is at the start of the contract
        // Let's trace selector -> JUMPDEST mapping

        console.log("Selector dispatch table:");

        // Find all selectors and their jump targets
        for (uint i = 0; i + 10 < 400 && i < code.length; i++) {
            if (uint8(code[i]) == 0x63) { // PUSH4 (selector)
                bytes4 sel = bytes4(bytes.concat(code[i+1], code[i+2], code[i+3], code[i+4]));

                // Check if followed by EQ
                bool hasEq = false;
                for (uint j = i + 5; j < i + 10 && j < code.length; j++) {
                    if (uint8(code[j]) == 0x14) {
                        hasEq = true;
                        break;
                    }
                }

                if (hasEq && uint32(sel) > 0x1000) {
                    // Find the PUSH2 (jump target) after EQ and JUMPI
                    for (uint j = i + 5; j < i + 20 && j < code.length; j++) {
                        if (uint8(code[j]) == 0x61) { // PUSH2
                            uint16 target = uint16(uint8(code[j+1])) << 8 | uint8(code[j+2]);
                            if (target > 100 && target < 10000) {
                                console.log("Selector:");
                                console.logBytes4(sel);
                                console.log("  -> JUMPDEST:", target);
                                break;
                            }
                        }
                    }
                }
            }
        }
    }

    function test_WhatFunctionHasCreate2() public view {
        console.log("=== FINDING FUNCTION CONTAINING CREATE2 ===\n");

        bytes memory code = REDEMPTION_0.code;

        // CREATE2 is at 5608
        // Find which function's code range contains 5608

        // Get all JUMPDEST targets from dispatcher
        uint16[] memory funcStarts = new uint16[](30);
        uint funcCount = 0;

        for (uint i = 0; i + 10 < 400 && i < code.length && funcCount < 30; i++) {
            if (uint8(code[i]) == 0x63) {
                bytes4 sel = bytes4(bytes.concat(code[i+1], code[i+2], code[i+3], code[i+4]));
                bool hasEq = false;
                for (uint j = i + 5; j < i + 10 && j < code.length; j++) {
                    if (uint8(code[j]) == 0x14) hasEq = true;
                }
                if (hasEq && uint32(sel) > 0x1000) {
                    for (uint j = i + 5; j < i + 20 && j < code.length; j++) {
                        if (uint8(code[j]) == 0x61) {
                            uint16 target = uint16(uint8(code[j+1])) << 8 | uint8(code[j+2]);
                            if (target > 100) {
                                funcStarts[funcCount] = target;
                                funcCount++;
                                break;
                            }
                        }
                    }
                }
            }
        }

        // Sort function starts
        for (uint i = 0; i < funcCount; i++) {
            for (uint j = i + 1; j < funcCount; j++) {
                if (funcStarts[j] < funcStarts[i]) {
                    uint16 tmp = funcStarts[i];
                    funcStarts[i] = funcStarts[j];
                    funcStarts[j] = tmp;
                }
            }
        }

        // Find which range contains 5608
        console.log("Function start addresses (sorted):");
        for (uint i = 0; i < funcCount; i++) {
            console.log("  ", funcStarts[i]);

            if (i + 1 < funcCount) {
                if (funcStarts[i] <= 5608 && funcStarts[i + 1] > 5608) {
                    console.log("  *** CREATE2 is in this function! ***");
                }
            }
        }
    }

    function test_CheckCreate2At136() public view {
        console.log("=== CHECKING CREATE2 AT OFFSET 136 ===\n");

        bytes memory code = REDEMPTION_0.code;

        // There's also CREATE2 at 136 - this is very early in the contract
        // This might be in the proxy initialization code

        console.log("Bytecode from 100 to 200:");

        uint i = 100;
        while (i < 200 && i < code.length) {
            uint8 op = uint8(code[i]);
            uint skipBytes = 0;

            if (op == 0x5b) console.log(i, "JUMPDEST");
            if (op == 0x33) console.log(i, "CALLER");
            if (op == 0x54) console.log(i, "SLOAD");
            if (op == 0xf4) console.log(i, "DELEGATECALL");
            if (op == 0xf5) console.log(i, "*** CREATE2 ***");
            if (op == 0x3b) console.log(i, "EXTCODESIZE");
            if (op == 0x15) console.log(i, "ISZERO");
            if (op == 0x57) console.log(i, "JUMPI");

            if (op >= 0x60 && op <= 0x7f) {
                uint8 size = op - 0x5f;
                uint256 val = 0;
                for (uint j = 0; j < size && i + 1 + j < code.length; j++) {
                    val = val << 8 | uint8(code[i + 1 + j]);
                }
                if (size == 32) {
                    console.log(i, "PUSH32:");
                    console.logBytes32(bytes32(val));
                } else if (val < 10000) {
                    console.log(i, "PUSH:", val);
                }
                skipBytes = size;
            }

            i += 1 + skipBytes;
        }
    }
}
