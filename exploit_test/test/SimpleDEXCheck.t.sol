// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address) external view returns (uint256);
}

interface ICurvePool {
    function get_virtual_price() external view returns (uint256);
}

contract SimpleDEXCheck is Test {
    address constant USDE = 0x4c9EDD5852cd905f086C759E8383e09bff1E68B3;
    address constant USDC = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
    
    // Curve USDe/USDC pool
    address constant CURVE_POOL = 0x02950460E2b9529D0E00284A5fA2d7bDF3fA4d72;
    
    string constant RPC_URL = "https://mainnet.infura.io/v3/bfc7283659224dd6b5124ebbc2b14e2c";
    
    function setUp() public {
        vm.createSelectFork(RPC_URL);
    }
    
    function test_CheckPoolBalances() public view {
        console.log("=== CURVE POOL BALANCE CHECK ===\n");
        
        // Check balances in pool to infer price
        uint256 usdeInPool = IERC20(USDE).balanceOf(CURVE_POOL);
        uint256 usdcInPool = IERC20(USDC).balanceOf(CURVE_POOL);
        
        console.log("Curve USDe/USDC Pool:");
        console.log("  USDe:", usdeInPool / 1e18);
        console.log("  USDC:", usdcInPool / 1e6);
        
        // If USDe > USDC (normalized), USDe is trading at discount
        // If USDe < USDC (normalized), USDe is trading at premium
        
        uint256 usdeNorm = usdeInPool / 1e12; // Normalize to 6 decimals
        
        console.log("\nNormalized comparison:");
        console.log("  USDe (6 dec):", usdeNorm / 1e6);
        console.log("  USDC:", usdcInPool / 1e6);
        
        if (usdeNorm > usdcInPool) {
            uint256 ratio = usdeNorm * 10000 / usdcInPool;
            console.log("\nUSDe at DISCOUNT (more USDe in pool)");
            console.log("  Ratio (10000 = parity):", ratio);
            console.log("  Implied USDe price: ~$", usdcInPool * 100 / usdeNorm, "/ 100");
        } else {
            uint256 ratio = usdcInPool * 10000 / usdeNorm;
            console.log("\nUSDe at PREMIUM (more USDC in pool)");
            console.log("  Ratio (10000 = parity):", ratio);
        }
        
        // Get virtual price
        try ICurvePool(CURVE_POOL).get_virtual_price() returns (uint256 vp) {
            console.log("\nVirtual Price:", vp);
        } catch {}
    }
}
