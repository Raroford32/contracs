# Delegatecall Hijacking Investigation Report

## Target Contracts
- **Strategy Contract**: `0x60d2D94aCB969CA54e781007eE89F04c1A2e5943` (Treehouse Protocol)
- **StrategyStorage**: `0x97c03F52244E60BB18511Cbf03f890D5886f1F47`
- **StrategyExecutor**: `0x89f57D3617F6a9FF877fEa34Dd0688b2840Ef50e`
- **ActionExecutor**: `0xb1593193Bcd7CEcc3d19597658003d735D1e9E94` (DeFiSaver)
- **Vault**: `0x551d155760ae96050439AD24Ae98A96c765d761B`

## Executive Summary

**FINDING: NO UNPRIVILEGED VULNERABILITY PROVEN**

The contract at `0x60d2D94aCB969CA54e781007eE89F04c1A2e5943` IS a verified contract - it's a **Treehouse Protocol Strategy** that uses delegatecall to execute actions.

### Access Control Verified:
| Attack Vector | Result |
|--------------|--------|
| Direct callExecute | BLOCKED - requires strategyExecutor |
| Direct execute | BLOCKED - requires self-call |
| executeOnStrategy (non-executor) | BLOCKED - requires whitelist |
| Executor registration | BLOCKED - requires owner |

**Current State**: Strategy has 0 ETH/token balance - no funds at risk currently.

---

## Architecture Analysis

### Execution Flow
```
User -> StrategyExecutor.executeOnStrategy()
     -> Strategy.callExecute(ActionExecutor, data)
     -> Strategy.execute() [self-call]
     -> delegatecall(ActionExecutor)
     -> ActionExecutor.executeActions()
     -> delegatecall(RegisteredAction)
```

### Strategy Contract (0x60d2D94aCB969CA54e781007eE89F04c1A2e5943)
```solidity
function callExecute(address _target, bytes memory _data) external payable returns (bytes32) {
    if (msg.sender != strategyStorage.strategyExecutor()) revert Unauthorized();  // CHECK 1
    if (_target == address(0)) revert Failed();
    _response = IStrategy(address(this)).execute{ value: msg.value }(_target, _data);
}

function execute(address _target, bytes memory _data) external payable returns (bytes32) {
    if (msg.sender != address(this)) revert Unauthorized();  // CHECK 2
    // delegatecall to _target
}
```

### Configuration
- **strategyStorage**: 0x97c03F52244E60BB18511Cbf03f890D5886f1F47
- **vault**: 0x551d155760ae96050439AD24Ae98A96c765d761B
- **Owner**: 0x2225DAbFfC7F862c99477381E971E8B1FDaB467e (CONTRACT - 7866 bytes, likely multisig)

---

## Whitelisted Actions (13 total)

| Action ID | Registered Address |
|-----------|-------------------|
| 0xd7e40b2d | Custom Treehouse action |
| 0x43142355 | Custom Treehouse action |
| 0xacd039ef | Custom Treehouse action |
| 0x2161dd34 | Custom Treehouse action |
| 0x245077a0 | Custom Treehouse action |
| 0x3d35d254 | Custom Treehouse action |
| 0xfc33bf00 | AaveV3Supply |
| 0x9e9290b1 | AaveV3Borrow |
| 0x17683e81 | AaveV3Payback |
| 0x72a6498a | AaveV3Withdraw |
| 0xfebcb52a | Unknown |
| 0x19713586 | Unknown |
| 0x4f18b88c | Unknown |

### Whitelisted Assets (2)
- 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0 (wstETH)
- 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2 (WETH)

---

## Attack Vectors Tested

### Vector 1: Direct callExecute
```solidity
strategy.callExecute(maliciousTarget, data);
```
**Result**: BLOCKED - Reverts with `Unauthorized()` because `msg.sender != strategyStorage.strategyExecutor()`

### Vector 2: Direct execute
```solidity
strategy.execute(maliciousTarget, data);
```
**Result**: BLOCKED - Reverts with `Unauthorized()` because `msg.sender != address(this)`

### Vector 3: executeOnStrategy as Non-Executor
```solidity
strategyExecutor.executeOnStrategy(0, actionIds, callDatas, mappings);
```
**Result**: BLOCKED - `executors[msg.sender] != true` check fails

### Vector 4: Register as Executor
**Result**: BLOCKED - `updateExecutor` is `onlyOwner`

### Vector 5: Bypass Action Whitelist
**Result**: BLOCKED - Actions must be whitelisted in StrategyStorage

---

## Centralization Risks (NOT Unprivileged Vulnerabilities)

1. **Owner Compromise**: Owner 0x2225DAbFfC7F862c99477381E971E8B1FDaB467e can:
   - Add malicious executors
   - Whitelist malicious actions
   - This would allow draining Strategy funds

2. **StrategyExecutor Owner**: Can add/remove executors who can trigger actions

---

## Current Balances

| Contract | ETH | WETH | USDC | USDT |
|----------|-----|------|------|------|
| Strategy | 0 | 0 | 0 | 0 |
| Vault | 0 | 0 | 0 | N/A |

**No funds currently at risk.**

---

## Conclusion

**STATUS: UNPROVEN - No unprivileged vulnerability found**

The Treehouse Protocol Strategy contract has multiple layers of access control:
1. Executor whitelist check
2. StrategyExecutor address check
3. Self-call requirement for execute()
4. Action whitelist in StrategyStorage

All these checks are functioning correctly. Exploitation would require:
- Compromising the owner multisig, OR
- Finding a vulnerability in a whitelisted action

---

## Reproduction Commands

```bash
# Run all analysis tests
forge test --match-contract TreehouseStrategyExploitTest -vvv
forge test --match-contract DelegatecallHijackTest -vvv
forge test --match-contract DelegatecallHijackDeepTest -vvv
forge test --match-contract DelegatecallExploitTest -vvv
```

---

## Files Created

- `test/TreehouseStrategyExploit.t.sol` - Treehouse Protocol analysis
- `test/DelegatecallHijack.t.sol` - Initial proxy analysis
- `test/DelegatecallHijackDeep.t.sol` - Deep DeFiSaver analysis
- `test/DelegatecallExploit.t.sol` - Attack vector testing
- `test/FINDINGS_DelegatecallHijacking.md` - This report
