#!/usr/bin/env python3
"""
Fetch full source code and analyze in detail.
Looking for cross-protocol semantic mismatches.
"""

import requests
import json
import time

ETHERSCAN_API = "https://api.etherscan.io/v2/api"
ETHERSCAN_KEY = "5UWN6DNT7UZCEJYNE3J6FCVAWH4QJW255K"

def get_full_source(address):
    url = f"{ETHERSCAN_API}?chainid=1&module=contract&action=getsourcecode&address={address}&apikey={ETHERSCAN_KEY}"
    try:
        resp = requests.get(url, timeout=30)
        data = resp.json()
        if data.get('status') == '1' and data.get('result'):
            return data['result'][0]
    except Exception as e:
        print(f"Error: {e}")
    return None

# Contracts to analyze deeply
contracts = [
    # High-value DeFi contracts that integrate with multiple protocols
    ("0xd96f48665a1410c0cd669a88898eca36b9fc2cce", "DegenBox"),  # Abracadabra
    ("0xf5bce5077908a1b7370b9ae04adc565ebd643966", "BentoBoxV1"),  # Sushi
    ("0x4e3fbd56cd56c3e72c1403e103b45db9da5b9d2b", "CVX"),  # Convex token
    ("0xf403c135812408bfbe8713b5a23a04b3d48aae31", "Booster"),  # Convex
    ("0x26fa3fffb6efe8c1e69103acb4044c26b9a106a9", "sSpellV1"),  # Spell staking
]

for addr, name in contracts:
    print(f"\n{'=' * 70}")
    print(f"FETCHING: {name} ({addr})")
    print(f"{'=' * 70}")

    source_data = get_full_source(addr)
    if source_data:
        source_code = source_data.get('SourceCode', '')
        contract_name = source_data.get('ContractName', 'Unknown')
        compiler = source_data.get('CompilerVersion', 'Unknown')

        print(f"Contract: {contract_name}")
        print(f"Compiler: {compiler}")
        print(f"Source length: {len(source_code)} chars")

        # Save to file for detailed analysis
        filename = f"source_{name.lower().replace(' ', '_')}.sol"
        with open(filename, 'w') as f:
            f.write(f"// Source: {addr}\n")
            f.write(f"// Contract: {contract_name}\n")
            f.write(f"// Compiler: {compiler}\n\n")
            f.write(source_code)
        print(f"Saved to: {filename}")

    time.sleep(1)  # Rate limit

print("\n\nFetching complete. Analyze the .sol files manually.")
