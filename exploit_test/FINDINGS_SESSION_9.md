# Novel Exploit Analysis - Session 9

## Executive Summary

This session focused on deep analysis of high-value smart contracts looking for **novel vulnerabilities** similar to recent exploits (Truebit $26M, Cetus $223M, Balancer $120M).

**Status: THEORETICAL VULNERABILITY FOUND - NOT CURRENTLY EXPLOITABLE**

---

## Critical Finding: BAMM PriceFormula Math Vulnerability

### Vulnerability Details

**Contract:** BAMM (B.Protocol AMM)
**Address:** 0x920623AcBa785ED9a70d33ACab53631e1e834675
**TVL:** ~$50M THUSD

### Technical Analysis

The BAMM uses a StableSwap-style curve with the following price formula:

```solidity
function getReturn(uint256 xQty, uint256 xBalance, uint256 yBalance, uint256 A) public pure returns(uint256) {
    uint256 sum = getSumFixedPoint(xBalance, yBalance, A);

    uint256 c = sum * sum / ((xQty + xBalance) * 2);
    c = c * sum / (A * 4);
    uint256 b = (xQty + xBalance) + (sum / (A * 2));

    // Newton's method iteration
    for(uint256 i = 0 ; i < 255 ; i++) {
        yPrev = y;
        uint256 n = y * y + c;
        uint256 d = y * 2 + b - sum;
        y = n / d;
        if(y <= yPrev + 1 && yPrev <= y + 1) break;
    }

    return yBalance - y - 1;
}
```

**Virtual Y Calculation in BAMM:**
```solidity
uint256 yBalance = thusdBalance + (collateralUsdValue * 2);
```

### Vulnerability Mechanism

When `collateralUsdValue` is high (post-liquidation), the y/x ratio increases, causing:

1. **Output > Input** for small swaps
2. **Profit scales with imbalance ratio**

### Profit Analysis (Verified on Mainnet Fork)

| Pool Ratio (y/x) | Input | Output | Profit |
|------------------|-------|--------|--------|
| 100% (balanced)  | 1 THUSD | ~1 USD | 0% |
| 200%             | 1 THUSD | ~1.19 USD | **19.45%** |
| 300%             | 1 THUSD | ~1.34 USD | **33.93%** |
| 500%             | 1 THUSD | ~1.71 USD | **71%** |
| 1000%            | 1 THUSD | ~3.06 USD | **206%** |

### Maximum Extractable Value

At current TVL (~$50M THUSD), if collateral accumulates to $75M:
- **Total Extractable: ~$4,052,949**

### Current State (NOT EXPLOITABLE)

| Parameter | Value |
|-----------|-------|
| THUSD in SP | 49,986,438 |
| Collateral Gain | **0** |
| Y/X Ratio | **100%** (balanced) |
| Status | **NOT EXPLOITABLE** |

### Trigger Condition

The exploit becomes viable when:
1. Major ETH price drop causes mass liquidations
2. BAMM accumulates collateral from Stability Pool
3. Y/X ratio increases above 100%

---

## Other Contracts Analyzed

### 1. StakingRewards (0x4F48...)
- **TVL:** ~$117M (steCRV LP tokens)
- **Status:** PROTECTED
- **Reason:** Rewards expired (May 2024), time-weighted earning prevents flash attacks

### 2. ERC20Handler (0x2F1d...)
- **TVL:** ~$110M (CHZ tokens - ChainBridge)
- **Status:** PROTECTED
- **Reason:** `onlyBridge` modifier on all withdrawal functions

### 3. PCV Controller (0x097f...)
- **TVL:** ~$50M (THUSD)
- **Status:** PROTECTED
- **Reason:** `onlyOwner` / governance controls

### 4. AcceleratingDistributor (0x9040...)
- **TVL:** 34M ACX tokens
- **Status:** REQUIRES FURTHER ANALYSIS
- **Note:** `cumulativeStaked = 0` flag seen in logs

---

## Additional Math Findings

### Overflow in getSumFixedPoint

The formula overflows when input ratios are extreme:
- **Threshold:** x > ~7e25 when y = 1
- **Impact:** Reverts transaction (not exploitable for profit)

### Rounding Direction

The `-1` at end of `getReturn()` is meant to protect against rounding in user's favor but can be insufficient in imbalanced pools.

---

## Methodology

1. **Source Code Analysis:** Retrieved contract source from Etherscan API
2. **Formula Isolation:** Tested PriceFormula in isolation with edge cases
3. **State Verification:** Checked live contract state on mainnet fork
4. **Profit Calculation:** Simulated various pool configurations

---

## Test Files Created

1. `BAMMDeepExploit.t.sol` - Initial BAMM state analysis
2. `BAMMPrecisionExploit.t.sol` - Precision edge case testing
3. `PriceFormulaOverflow.t.sol` - Formula overflow analysis
4. `BAMMPrecisionProfit.t.sol` - Profit potential simulation
5. `RealBAMMExploit.t.sol` - Live contract verification
6. `FocusedAnalysis.t.sol` - Summary of all high-value contracts

---

## Conclusion

**No immediately executable exploits found in this session.**

The BAMM PriceFormula vulnerability is real and verified, but requires a market event (liquidations) to become exploitable. This is similar to:
- Balancer v2 (~$120M) - required specific pool configurations
- Cetus (~$223M) - required overflow conditions

The vulnerability exists in the contract code and could yield ~$4M+ if market conditions align.

---

## Recommendations for Protocol

1. Add checks for minimum/maximum y/x ratio in swap function
2. Implement circuit breaker when collateral gain exceeds threshold
3. Consider rounding direction audit by math specialists
